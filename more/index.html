<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box }
    html,body {
      width:100%; height:100vh; overflow:hidden;
      font-family:Arial,sans-serif; background:#f9f9f9;
      cursor:auto;
    }
    button { transition:transform .1s; user-select:none; }
    button:active { transform:scale(.95); }

    /* APP & VERSION */
    #app { position:relative; width:100%; height:100% }
    #version-label {
      position:fixed; bottom:10px; left:10px;
      color:#555; font-size:.9em; z-index:9999;
    }
    #devButton {
      position:fixed; top:0; right:0;
      width:50px; height:50px; opacity:0;
      z-index:9999;
    }

    /* SCREENS */
    .screen {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:90%; max-width:800px;
      text-align:center; display:none;
    }
    .screen.active { display:block }

    /* LOGO */
    #logo-screen img {
      width:260px; height:260px; border-radius:50%;
      box-shadow:0 0 20px rgba(0,0,0,.3);
      animation:pulse 2s infinite alternate;
    }
    @keyframes pulse { from{transform:scale(1)} to{transform:scale(1.03)} }
    #logo-screen h2 {
      margin-top:15px; font-size:2.2em; color:#333;
    }

    /* KEYPAD */
    #keypad-screen h2 { margin-bottom:20px; font-size:1.8em; color:#333 }
    #digit-display { display:flex; justify-content:center; margin-bottom:20px }
    .digit-box {
      width:60px; height:60px; margin:0 4px;
      border-bottom:2px solid #333;
      font-size:2.5em; line-height:60px;
    }
    .keypad-grid {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:8px; justify-items:center;
    }
    .keypad-btn {
      width:80px; height:80px; border-radius:50%;
      background:rgba(0,0,0,.1); color:#333;
      font-size:2em; display:flex;
      align-items:center; justify-content:center;
    }
    .keypad-btn.backspace { background:#e74c3c; color:#fff }
    .shake { animation:shake .5s }
    @keyframes shake {
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-8px)}
      75%{transform:translateX(8px)}
    }

    /* SNACK SCREEN */
    #snack-screen {
      padding-top:80px; position:relative;
    }
    #student-name {
      position:absolute; top:10px; left:20px;
      font-size:1.8em; color:#333;
    }
    #menuBtn, #snack-signout {
      position:absolute; top:10px; padding:10px 20px;
      font-size:1em; border:none; border-radius:4px;
    }
    #menuBtn {
      right:140px; background:#3498db; color:#fff;
      display:none;
    }
    #snack-signout {
      right:20px; background:#e74c3c; color:#fff;
    }
    #snack-screen h2 {
      font-size:2em; margin-bottom:30px; color:#333;
    }
    #snack-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:15px; justify-items:center;
    }
    .snack-item {
      position:relative;
      background:#fff; border:1px solid #ddd;
      padding:12px; border-radius:6px;
      cursor:pointer; transition:box-shadow .2s;
      width:100%; max-width:160px;
    }
    .snack-item:hover { box-shadow:0 2px 8px rgba(0,0,0,.1) }
    .snack-item.disabled { opacity:.6 }
    .snack-item h4 { margin-bottom:6px; font-size:1.2em; color:#222 }
    .snack-item p { font-size:.9em; color:#555; margin-bottom:4px }
    .snack-item .limit {
      font-size:.9em; font-weight:bold; color:#2980b9;
    }
    .snack-item .overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      text-align:center; font-size:1em; font-weight:bold;
      color:#c0392b; background:rgba(255,255,255,.8);
      border-radius:6px; white-space:pre-line;
    }

    #dispense-button {
      margin-top:30px; padding:14px 28px;
      font-size:1.2em; background:#2ecc71; color:#fff;
      border:none; border-radius:6px; display:none;
      cursor:pointer;
    }

    /* DISPENSE SCREEN */
    #dispense-screen {
      width:80%; max-width:500px;
      background:#2e3192; color:#fff;
      border-radius:12px; padding:30px;
    }
    #dispense-screen img { width:80px; height:80px; margin-bottom:15px }
    #dispense-screen h2 { font-size:2em; margin-bottom:10px }
    #dispense-text { font-size:1.1em; margin-bottom:15px }
    #dispense-screen p { font-size:1.3em; margin-bottom:20px }
    #stay-signed-btn {
      background:#2980b9; padding:10px 20px;
      font-size:1em; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }

    /* MODALS & BACKDROP */
    .modal-backdrop {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.4); display:none; z-index:1000;
    }
    .modal-backdrop.active { display:block }

    .modal {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; padding:20px;
      border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,.3);
      width:90%; max-width:360px;
      display:none; z-index:1001;
      text-align:left;
    }
    .modal.active { display:block }
    .modal h3 { margin-bottom:15px; font-size:1.3em }

    .modal .closeBtn {
      margin-top:20px; padding:8px 16px;
      font-size:1em; background:#3498db;
      color:#fff; border:none; border-radius:4px;
      cursor:pointer;
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
      gap:10px;
    }

    .modal label {
      display:block; margin-bottom:10px; font-size:.95em;
    }
    .modal input[type="text"],
    .modal input[type="number"] {
      width:100%; padding:6px 8px; border:1px solid #ccc;
      border-radius:4px; font-size:1em;
    }
    .modal button { margin-right:8px }

  </style>
</head>
<body>
  <div id="app">
    <button id="devButton"></button>

    <!-- LOGO -->
    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo" />
      <h2>Tap or press any key to begin</h2>
    </div>

    <!-- KEYPAD -->
    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons"></div>
    </div>

    <!-- SNACK SELECTION -->
    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button id="menuBtn">Menu</button>
      <button id="snack-signout">Sign Out</button>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense</button>
    </div>

    <!-- DISPENSE CONFIRMATION -->
    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo" />
      <h2 id="thank-you-msg">Thank you!</h2>
      <div id="dispense-text">Your snack(s) are on the way</div>
      <p>Signing out in <span id="countdown">5</span>…</p>
      <button id="stay-signed-btn">Stay Signed In</button>
    </div>

    <!-- BACKDROP FOR ALL MODALS -->
    <div id="backdrop" class="modal-backdrop"></div>

    <!-- DEV MENU MODAL -->
    <div id="devMenu" class="modal">
      <h3>Dev Menu</h3>
      <button id="openConfig">Set Local Key</button>
      <button id="openStockMgmt">Stock Management</button>
      <button class="closeBtn" id="devMenuClose">Close</button>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal">
      <h3>Set Local Secret Key</h3>
      <label>Key:<br />
        <input id="configInput" type="text" placeholder="Enter secret key" />
      </label>
      <button class="closeBtn" id="configSave">Save</button>
      <button class="closeBtn" id="configClose">Close</button>
    </div>

    <!-- STOCK MANAGEMENT MODAL -->
    <div id="stockModal" class="modal">
      <h3>Stock Management</h3>
      <div id="stockGrid" class="grid"></div>
      <button class="closeBtn" id="stockClose">Close</button>
    </div>

    <!-- ITEM EDIT MODAL -->
    <div id="editModal" class="modal">
      <h3 id="editTitle">Edit Item</h3>
      <label>Name:<br /><input id="editName" type="text" /></label>
      <label>Stock:<br /><input id="editStock" type="number" min="0" /></label>
      <label><input id="editEnabled" type="checkbox" /> Enabled</label>
      <button class="closeBtn" id="editSave">Save</button>
      <button class="closeBtn" id="editCancel">Cancel</button>
    </div>

    <div id="version-label">v3.0.0</div>
  </div>

  <script>
    // VERSION
    const APP_VERSION = "v3.0.0";

    // FIREBASE INIT
    const cfg = {
      apiKey: "AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
      authDomain: "cyberflashvend.firebaseapp.com",
      databaseURL: "https://cyberflashvend-default-rtdb.firebaseio.com",
      projectId: "cyberflashvend",
      storageBucket: "cyberflashvend.firebasestorage.app",
      messagingSenderId: "63786658773",
      appId: "1:63786658773:web:7792d3693ef45e9ec4eb5c"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // STATE
    let currentScreen="logo",
        studentId="",
        userKey="",
        serverSecret=null,
        snacks=[
          {id:"A1",name:"Chips"},
          {id:"A2",name:"Cookies"},
          {id:"A3",name:"Pretzels"},
          {id:"B1",name:"Candy Bar"},
          {id:"B2",name:"Granola Bar"},
          {id:"B3",name:"Trail Mix"}
        ],
        selected=new Set();

    const STUDENTS={
      "260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi",
      "250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones",
      "280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley",
      "250606":"Madeline Penney","250639":"Rohan Rajanahalli","260627":"Mason Robbins"
    };

    // ON LOAD
    window.addEventListener("load", async ()=>{
      // fetch Config secret
      serverSecret = (await db.ref("Config").once("value")).val();
      document.getElementById("version-label").textContent = APP_VERSION;
      setup();
    });

    function setup(){
      setupIdleLogout();
      setupLogo();
      setupKeypad();
      setupSnack();
      setupDispense();
      setupDevMenu();
      setupConfigModal();
      setupStockMgmt();
      setupEditModal();
    }

    // IDLE LOGOUT
    let idleTimer;
    function setupIdleLogout(){
      ["keydown","click","mousemove","touchstart"].forEach(e=>
        document.addEventListener(e,resetIdle));
      resetIdle();
    }
    function resetIdle(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(signOut,90_000);
    }

    // SCREEN SWITCH
    function showScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentScreen = id;
      document.getElementById("menuBtn").style.display = 
        (id==="snack-screen" && studentId==="DEV MODE")?"inline-block":"none";
    }

    // LOGO -> KEYPAD
    function setupLogo(){
      const logo=document.querySelector("#logo-screen img"),
            txt=document.querySelector("#logo-screen h2");
      ["click","touchstart"].forEach(evt=>{
        logo.addEventListener(evt,e=>startKeypad(e),{passive:false});
        txt.addEventListener(evt,e=>startKeypad(e),{passive:false});
      });
      window.addEventListener("keydown",()=>currentScreen==="logo"&&startKeypad());
    }
    function startKeypad(e){
      if(e&&e.type==="touchstart") e.preventDefault();
      showScreen("keypad-screen");
      initKeypad();
    }

    // KEYPAD
    const digitDisplay=document.getElementById("digit-display"),
          keypadButtons=document.getElementById("keypad-buttons"),
          layout=["1","2","3","4","5","6","7","8","9","","0","backspace"],
          maxD=6;
    function setupKeypad(){
      layout.forEach(val=>{
        const btn=document.createElement("div");
        if(!val){
          btn.style.width="80px"; btn.style.height="80px";
        } else {
          btn.className="keypad-btn";
          if(val==="backspace"){
            btn.classList.add("backspace"); btn.textContent="←";
            btn.addEventListener("click",handleBack);
          } else {
            btn.textContent=val;
            btn.addEventListener("click",()=>handleDigit(val));
          }
        }
        keypadButtons.appendChild(btn);
      });
      window.addEventListener("keydown",e=>{
        if(currentScreen!=="keypad-screen")return;
        if(/\d/.test(e.key)) handleDigit(e.key);
        else if(e.key==="Backspace") handleBack();
        else if(e.key==="Enter" && studentId.length===maxD) validateID();
      });
    }
    function renderDigits(){
      digitDisplay.innerHTML="";
      for(let i=0;i<maxD;i++){
        const d=document.createElement("div");
        d.className="digit-box";
        d.textContent = i<studentId.length?"•":"_";
        digitDisplay.appendChild(d);
      }
    }
    function initKeypad(){
      studentId="";
      renderDigits();
    }
    function handleDigit(ch){
      if(studentId.length<maxD){
        studentId+=ch; renderDigits();
        if(studentId.length===maxD) validateID();
      }
    }
    function handleBack(){
      if(!studentId) return;
      studentId=studentId.slice(0,-1); renderDigits();
    }
    async function validateID(){
      if(!STUDENTS[studentId]){
        digitDisplay.classList.add("shake");
        setTimeout(()=>digitDisplay.classList.remove("shake"),500);
        studentId=""; renderDigits();
        return alert("Invalid ID");
      }
      document.getElementById("student-name").textContent = STUDENTS[studentId];
      userKey = STUDENTS[studentId].replace(/ /g,"_");
      // fetch machine + user limits
      const [mS,uS] = await Promise.all([
        db.ref("machineManagement").once("value"),
        db.ref(`userManagement/${userKey}/Limits`).once("value")
      ]);
      const mD = mS.val()||{}, uD = uS.val()||{};
      snacks = snacks.map(s=>{
        const cfg = mD[s.id]||{};
        return {
          id:s.id,
          name:s.name,
          enabled: cfg.enabled !== false,
          quantity: cfg.stock!=null?cfg.stock:0,
          limit:   uD[s.id]!=null?uD[s.id]:null
        };
      });
      showScreen("snack-screen");
      renderSnackGrid();
    }

    // SNACK GRID
    const grid=document.getElementById("snack-grid"),
          dispenseBtn=document.getElementById("dispense-button");
    function setupSnack(){
      document.getElementById("snack-signout")
        .addEventListener("click",signOut);
      dispenseBtn.addEventListener("click",proceedToDispense);
    }
    function renderSnackGrid(){
      grid.innerHTML=""; selected.clear(); dispenseBtn.style.display="none";
      snacks.forEach(s=>{
        const card=document.createElement("div");
        card.className="snack-item";
        if(!s.enabled||s.quantity===0||s.limit===0) card.classList.add("disabled");
        card.innerHTML=`
          <h4>${s.name}</h4>
          <p>ID: ${s.id} | Qty: ${s.quantity}</p>
          <p class="limit">Limit: ${s.limit===null?"N/A":s.limit}</p>
        `;
        if(s.quantity===0)
          card.innerHTML+=`<div class="overlay">OUT\nOF\nSTOCK</div>`;
        else if(s.limit===0)
          card.innerHTML+=`<div class="overlay">LIMIT\nREACHED</div>`;
        card.onclick=()=>{
          if(!s.enabled||s.quantity===0||s.limit===0) return;
          if(selected.has(s.id)){
            selected.delete(s.id); card.style.boxShadow="";
          } else {
            selected.add(s.id); card.style.boxShadow="0 0 0 3px #27ae60";
          }
          dispenseBtn.style.display = selected.size?"inline-block":"none";
        };
        grid.appendChild(card);
      });
    }

    // DISPENSE
    async function proceedToDispense(){
      if(!selected.size) return;
      const localKey = localStorage.getItem("secretKey");
      if(localKey!==serverSecret) return alert("Unauthorized");
      // update both stock & limits
      const updates={};
      snacks.forEach(s=>{
        if(selected.has(s.id)){
          updates[`machineManagement/${s.id}/stock`] = s.quantity-1;
          updates[`userManagement/${userKey}/Limits/${s.id}`] = (s.limit||0)-1;
        }
      });
      await db.ref().update(updates);
      // show dispense screen
      showScreen("dispense-screen");
      initDispenseTimer();
    }

    // DISPENSE SCREEN
    function setupDispense(){
      document.getElementById("stay-signed-btn")
        .addEventListener("click",()=>showScreen("snack-screen"));
    }
    let countdownTimer, countdownValue=5;
    function initDispenseTimer(){
      document.getElementById("thank-you-msg").textContent =
        `Thank you, ${STUDENTS[studentId].split(" ")[0]}!`;
      countdownValue=5;
      document.getElementById("countdown").textContent=5;
      clearInterval(countdownTimer);
      countdownTimer = setInterval(()=>{
        countdownValue--;
        document.getElementById("countdown").textContent= countdownValue;
        if(countdownValue<=0){
          clearInterval(countdownTimer);
          signOut();
        }
      },1000);
    }

    // DEV MENU
    function setupDevMenu(){
      const devBtn=document.getElementById("devButton"),
            menuBtn=document.getElementById("menuBtn"),
            devMenu=document.getElementById("devMenu"),
            backdrop=document.getElementById("backdrop"),
            close=document.getElementById("devMenuClose"),
            openConfig=document.getElementById("openConfig"),
            openStock=document.getElementById("openStockMgmt");
      // activate dev
      window.addEventListener("keydown",e=>{
        if(e.key.toLowerCase()==="d" && currentScreen==="logo"){
          activateDev();
        }
      });
      devBtn.addEventListener("click",activateDev);
      function activateDev(){
        studentId="DEV MODE";
        document.getElementById("student-name").textContent="DEV MODE";
        showScreen("snack-screen");
        renderSnackGrid();
      }
      // open/close menu
      menuBtn.addEventListener("click",()=>{
        backdrop.classList.add("active");
        devMenu.classList.add("active");
      });
      close.onclick = () => {
        backdrop.classList.remove("active");
        devMenu.classList.remove("active");
      };
      // open config & stock
      openConfig.onclick = ()=>{ 
        backdrop.classList.add("active");
        document.getElementById("configModal").classList.add("active");
        devMenu.classList.remove("active");
      };
      openStock.onclick = ()=>{
        backdrop.classList.add("active");
        document.getElementById("stockModal").classList.add("active");
        devMenu.classList.remove("active");
      };
      // backdrop click closes any modal
      backdrop.addEventListener("click",closeAllModals);
    }
    function closeAllModals(){
      document.querySelectorAll(".modal.active, .modal-backdrop.active")
        .forEach(el=>el.classList.remove("active"));
    }

    // CONFIG MODAL
    function setupConfigModal(){
      const cfgM=document.getElementById("configModal"),
            cfgInp=document.getElementById("configInput"),
            save=document.getElementById("configSave"),
            close=document.getElementById("configClose"),
            backdrop=document.getElementById("backdrop");
      save.addEventListener("click",()=>{
        const k=cfgInp.value.trim();
        if(!k) return alert("Key cannot be empty");
        localStorage.setItem("secretKey",k);
        alert("Local key saved");
        closeAllModals();
      });
      close.addEventListener("click",closeAllModals);
    }

    // STOCK MANAGEMENT
    function setupStockMgmt(){
      const stockG=document.getElementById("stockGrid"),
            close=document.getElementById("stockClose"),
            backdrop=document.getElementById("backdrop");
      close.onclick = closeAllModals;
      function populate(){
        stockG.innerHTML="";
        snacks.forEach(s=>{
          const c=document.createElement("div");
          c.className="snack-item";
          c.innerHTML=`<h4>${s.id}</h4><p>${s.name}</p><p>Qty: ${s.quantity}</p>`;
          c.onclick=()=>openEdit(s.id);
          stockG.appendChild(c);
        });
      }
      document.getElementById("openStockMgmt")
        .addEventListener("click",populate);
    }

    // EDIT MODAL
    function setupEditModal(){
      const eM=document.getElementById("editModal"),
            eTitle=document.getElementById("editTitle"),
            eName=document.getElementById("editName"),
            eStock=document.getElementById("editStock"),
            eEnabled=document.getElementById("editEnabled"),
            save=document.getElementById("editSave"),
            cancel=document.getElementById("editCancel"),
            backdrop=document.getElementById("backdrop");
      cancel.onclick = closeAllModals;
      save.onclick = async ()=>{
        const id = eTitle.textContent.split(" ")[1],
              nm = eName.value.trim(),
              st = +eStock.value,
              en = eEnabled.checked;
        if(!nm||st<0) return alert("Invalid values");
        await db.ref(`machineManagement/${id}`)
          .set({ stock:st, enabled:en });
        // update in-memory
        const s = snacks.find(x=>x.id===id);
        s.name=nm; s.quantity=st; s.enabled=en;
        renderSnackGrid();
        closeAllModals();
      };
      window.openEdit = id =>{
        const s = snacks.find(x=>x.id===id);
        eTitle.textContent=`Edit ${id}`;
        eName.value = s.name;
        eStock.value = s.quantity;
        eEnabled.checked = s.enabled;
        backdrop.classList.add("active");
        eM.classList.add("active");
      };
    }

    // SIGN OUT
    function signOut(){
      clearInterval(countdownTimer);
      showScreen("logo-screen");
    }

  </script>
</body>
</html>
