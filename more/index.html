<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { width:100%; height:100%; font-family:Arial,sans-serif; background:#fff; }
    html,body,button,a { cursor:none!important; }
    button { transition:transform .1s; user-select:none; }
    button:active { transform:scale(.95); }

    /* APP & VERSION */
    #app { position:relative; width:100%; height:100%; }
    #version-label { position:fixed; bottom:10px; left:10px; color:#555; z-index:9999; }
    #devButton { position:fixed; top:0; right:0; width:50px; height:50px; background:transparent; border:none; opacity:0; z-index:9999; }

    /* SCREENS */
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:800px; text-align:center; display:none; }
    .screen.active { display:block; }

    /* LOGO */
    #logo-screen img { width:300px; height:300px; border-radius:50%; box-shadow:0 0 20px rgba(0,0,0,.5); animation:pulse 2s infinite alternate; }
    @keyframes pulse{ from{transform:scale(1)} to{transform:scale(1.05)} }
    #logo-screen h2 { margin-top:20px; font-size:2.5em; color:#333; }

    /* KEYPAD */
    #keypad-screen h2 { margin-bottom:20px; font-size:2.2em; color:#333; }
    #digit-display { display:flex; justify-content:center; margin-bottom:20px; }
    .digit-box { width:70px; height:70px; margin:0 5px; border-bottom:2px solid #333; font-size:3em; line-height:70px; }
    .keypad-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; justify-items:center; }
    .keypad-btn { width:100px; height:100px; border-radius:50%; background:rgba(0,0,0,.1); color:#333; font-size:2.5em; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .keypad-btn.backspace { background:red; color:#fff; }
    .shake { animation:shake .5s; }
    @keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}100%{transform:translateX(0)}}

    /* SNACK */
    #snack-screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:800px; padding-top:100px; text-align:center; }
    #student-name { position:absolute; top:10px; left:20px; font-size:2em; color:#333; }
    #snack-signout, #openConfigBtn, #openShowKeyBtn { position:absolute; top:10px; padding:8px 12px; border:none; border-radius:4px; font-size:0.9em; cursor:pointer; }
    #snack-signout { right:20px; background:#e74c3c; color:#fff; }
    #openConfigBtn  { left:50%; transform:translateX(-150%); background:#007bff; color:#fff; }
    #openShowKeyBtn { left:50%; transform:translateX(50%);  background:#007bff; color:#fff; }
    #snack-screen h2 { font-size:2.5em; margin-bottom:30px; color:#333; }
    #snack-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; margin-bottom:120px; justify-items:center; }
    .snack-item { background:rgba(0,0,0,.05); border:2px solid transparent; padding:15px; border-radius:8px; cursor:pointer; transition:background .3s,border-color .3s; text-align:center; }
    .snack-item.selected { background:rgba(52,152,219,.4); border-color:#3498db; }
    .snack-item h4 { margin-bottom:5px; font-size:1.6em; }
    .snack-item p { font-size:1.2em; }
    #dispense-button { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); padding:25px 35px; font-size:1.8em; background:#2ecc71; border:none; border-radius:8px; color:#fff; cursor:pointer; display:none; }

    /* DISPENSE */
    #dispense-screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:600px; background:rgba(0,0,139,.8); border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,.5); color:#fff; padding:30px; text-align:center; }
    #dispense-screen img { width:100px; height:100px; border-radius:50%; margin-bottom:15px; }
    #dispense-screen h2 { margin-bottom:10px; font-size:2.5em; }
    #dispense-screen p { margin-bottom:20px; font-size:1.5em; }
    #dispense-screen .stay-signed { padding:15px 30px; background:#2980b9; border:none; border-radius:5px; color:#fff; cursor:pointer; font-size:1.5em; }

    /* MODALS */
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.3); display:none; z-index:10000; text-align:center; }
    .modal input  { width:200px; padding:5px; margin-bottom:10px; }
    .modal button { margin:5px; padding:6px 12px; }

    /* MOBILE */
    @media(max-width:600px){
      #logo-screen img{width:250px;height:250px;} 
      #logo-screen h2{font-size:2.2em;}
      .digit-box{width:80px;height:80px;font-size:3.5em;line-height:80px;}
      .keypad-btn{width:90px;height:90px;font-size:2.2em;}
      #student-name{font-size:1.8em;}
      #snack-signout,#openConfigBtn,#openShowKeyBtn{font-size:1.2em;padding:8px;}
      #snack-screen h2{font-size:2.2em;}
      .snack-item h4{font-size:1.8em;}
      #dispense-button{font-size:2em;padding:30px 40px;}
      #dispense-screen h2,#dispense-screen p{font-size:1.8em;}
      #dispense-screen .stay-signed{font-size:1.8em;}
    }
  </style>
</head>
<body>
  <div id="app">
    <button id="devButton"></button>

    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo" />
      <h2>Tap to Begin</h2>
    </div>

    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons"></div>
    </div>

    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button id="snack-signout">Sign Out</button>
      <button id="openConfigBtn">Set Key</button>
      <button id="openShowKeyBtn">View Key</button>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>

    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo" />
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-info">
        <h3 id="dispense-text">Your snack(s) will be dispensed shortly</h3>
        <p>Signing you out in <span id="countdown">5</span></p>
      </div>
      <button id="stay-signed-btn">Stay Signed In</button>
    </div>

    <div id="configModal" class="modal">
      <h3>Set Secret Key</h3>
      <input id="configInput" placeholder="New secret key" />
      <br/>
      <button id="configSave">Save</button>
      <button id="configClose">Close</button>
    </div>

    <div id="showKeyModal" class="modal">
      <h3>Saved Key</h3>
      <p><strong id="savedKeyText"></strong></p>
      <button id="showKeyClose">Close</button>
    </div>

    <div id="version-label"></div>
  </div>

  <script>
    // ---------- APP VERSION ----------
    const APP_VERSION = "v2.6.2";

    // ---------- Firebase init ----------
    const cfg = {
      apiKey: "AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
      authDomain: "cyberflashvend.firebaseapp.com",
      databaseURL: "https://cyberflashvend-default-rtdb.firebaseio.com",
      projectId: "cyberflashvend",
      storageBucket: "cyberflashvend.firebasestorage.app",
      messagingSenderId: "63786658773",
      appId: "1:63786658773:web:7792d3693ef45e9ec4eb5c"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // ---------- Secret‐key gate ----------
    let writeAllowed = false;
    async function checkSecret(){
      try {
        const snap = await db.ref("Config").once("value");
        const serverKey = snap.val();
        const localKey  = localStorage.getItem("secretKey");
        if(localKey === serverKey){
          writeAllowed = true;
          initApp();
          return;
        }
        const entry = prompt("Enter secret key:");
        if(entry === serverKey){
          localStorage.setItem("secretKey", entry);
          writeAllowed = true;
        } else {
          alert("Incorrect key – writes disabled");
        }
      } catch(e){
        console.error("Config read error", e);
        alert("Cannot verify key – writes disabled");
      }
      initApp();
    }
    checkSecret();

    // ---------- Globals ----------
    let currentScreen   = "logo",
        studentId       = "",
        selectedItems   = new Set(),
        countdownTimer  = null,
        countdownValue  = 5,
        idleTimer       = null;

    const STUDENTS = {
      "260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi",
      "250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones",
      "280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley",
      "250606":"Madeline Penney","250639":"Rohan Rajanahalli","260627":"Mason Robbins"
    };
    const snacks = [
      {id:"A1",name:"Chips",quantity:8},
      {id:"A2",name:"Cookies",quantity:5},
      {id:"A3",name:"Pretzels",quantity:12},
      {id:"B1",name:"Candy Bar",quantity:7},
      {id:"B2",name:"Granola Bar",quantity:3},
      {id:"B3",name:"Trail Mix",quantity:9}
    ];

    // ---------- Idle logout ----------
    function resetIdle(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(signOut, 90*1000);
    }
    ["keydown","click","mousemove","touchstart"].forEach(evt =>
      document.addEventListener(evt, resetIdle)
    );
    resetIdle();

    // ---------- Show screen helper ----------
    function showScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentScreen = id.split("-")[0];
      // dev button gating
      if(currentScreen !== "logo" || studentId !== ""){
        devButton.disabled = true;
        devButton.style.pointerEvents = "none";
      } else {
        devButton.disabled = false;
        devButton.style.pointerEvents = "auto";
      }
    }

    // ---------- Initialize after secret check ----------
    function initApp(){
      // set version label
      document.getElementById("version-label").textContent = APP_VERSION;

      setupDevKey();
      setupLogo();
      setupKeypad();
      setupSnack();
      setupDispense();
      setupModals();
    }

    // ---------- Enable cursor in dev mode ----------
    function enableCursor(){
      if(document.getElementById("cursorOverride")) return;
      const style = document.createElement("style");
      style.id = "cursorOverride";
      style.innerHTML = `
        html, body, button, a {
          cursor: auto !important;
        }
      `;
      document.head.appendChild(style);
    }

    // ---------- Dev via 'd' or invisible button ----------
    const devButton = document.getElementById("devButton");
    function setupDevKey(){
      window.addEventListener("keydown", e => {
        if(e.key.toLowerCase()==="d"){
          activateDev();
        }
      });
      devButton.addEventListener("click", activateDev);
    }
    function activateDev(){
      studentId = "DEV MODE";
      document.getElementById("student-name").textContent = "DEV MODE";
      showScreen("snack-screen");
      initSnack();
      enableCursor();
    }

    // ---------- Logo Screen ----------
    function setupLogo(){
      const logo = document.getElementById("logo-screen");
      logo.addEventListener("click", ()=>{
        showScreen("keypad-screen");
        initKeypad();
      });
      window.addEventListener("keydown", e => {
        if(currentScreen==="logo"){
          showScreen("keypad-screen");
          initKeypad();
        }
      });
    }

    // ---------- Keypad Screen ----------
    const digitDisplay   = document.getElementById("digit-display"),
          keypadButtons  = document.getElementById("keypad-buttons"),
          maxDigits      = 6;
    function isNumKey(e){
      return (e.key>="0"&&e.key<="9") || (e.code.startsWith("Numpad")&&e.key.length===1);
    }
    const layout = ["1","2","3","4","5","6","7","8","9","","0","backspace"];

    function setupKeypad(){
      initKeypad();
      window.addEventListener("keydown", e=>{
        if(currentScreen==="keypad"){
          if(e.repeat) return;           // ignore repeats
          if(isNumKey(e)){
            e.preventDefault();
            handleDigit(e.key.slice(-1));
          } else if(e.key==="Backspace"){
            e.preventDefault();
            handleBack();
          } else if((e.key==="Enter"||e.key==="NumpadEnter") && studentId.length===maxDigits){
            e.preventDefault();
            validateID();
          }
        }
      });
    }
    function initKeypad(){
      studentId="";
      renderDigits();
      if(!keypadButtons.children.length){
        layout.forEach(val=>{
          if(!val){
            const ph = document.createElement("div");
            ph.style.width="100px"; ph.style.height="100px";
            keypadButtons.appendChild(ph);
          } else {
            const btn = document.createElement("div");
            btn.classList.add("keypad-btn");
            if(val==="backspace"){
              btn.classList.add("backspace");
              btn.textContent="←";
              btn.addEventListener("click", handleBack);
            } else {
              btn.textContent = val;
              btn.addEventListener("click", ()=>handleDigit(val));
            }
            keypadButtons.appendChild(btn);
          }
        });
      }
    }
    function renderDigits(){
      digitDisplay.innerHTML="";
      for(let i=0;i<maxDigits;i++){
        const d = document.createElement("div");
        d.classList.add("digit-box");
        d.textContent = i<studentId.length?"•":"_";
        digitDisplay.appendChild(d);
      }
    }
    function handleDigit(ch){
      if(studentId.length<maxDigits){
        studentId += ch;
        renderDigits();
        if(studentId.length===maxDigits) validateID();
      }
    }
    function handleBack(){
      if(studentId.length){
        studentId = studentId.slice(0,-1);
        renderDigits();
      }
    }
    function validateID(){
      if(STUDENTS[studentId]){
        document.getElementById("student-name").textContent = STUDENTS[studentId];
        showScreen("snack-screen");
        initSnack();
      } else {
        digitDisplay.classList.add("shake");
        setTimeout(()=>{
          digitDisplay.classList.remove("shake");
          studentId = "";
          renderDigits();
        },500);
      }
    }

    // ---------- Snack Screen ----------
    const snackGrid     = document.getElementById("snack-grid"),
          dispenseBtn   = document.getElementById("dispense-button"),
          signOutBtn    = document.getElementById("snack-signout"),
          configBtn     = document.getElementById("openConfigBtn"),
          showKeyBtn    = document.getElementById("openShowKeyBtn");

    function setupSnack(){
      signOutBtn.addEventListener("click", signOut);
      dispenseBtn.addEventListener("click", proceedToDispense);
      window.addEventListener("keydown", e=>{
        if(currentScreen==="snack"){
          if(isNumKey(e)){
            const idx = +e.key.slice(-1) - 1;
            if(idx>=0 && idx<snacks.length){
              toggleSnack(snacks[idx].id, snackGrid.children[idx]);
            }
          } else if((e.key==="Enter"||e.key==="NumpadEnter") && selectedItems.size){
            proceedToDispense();
          } else if(e.key==="Escape"){
            signOut();
          }
        }
      });
      configBtn.addEventListener("click", openConfigModal);
      showKeyBtn.addEventListener("click", openShowKeyModal);
    }
    function initSnack(){
      selectedItems.clear();
      snackGrid.innerHTML="";
      snacks.forEach(s=>{
        const div = document.createElement("div");
        div.classList.add("snack-item");
        div.innerHTML = `<h4>${s.name}</h4><p>ID: ${s.id} | Qty: ${s.quantity}</p>`;
        div.addEventListener("click", ()=>toggleSnack(s.id,div));
        snackGrid.appendChild(div);
      });
      dispenseBtn.style.display = "none";
      if(studentId==="DEV MODE"){
        configBtn.style.display   = "block";
        showKeyBtn.style.display  = "block";
      } else {
        configBtn.style.display   = "none";
        showKeyBtn.style.display  = "none";
      }
    }
    function toggleSnack(id,el){
      if(selectedItems.has(id)){
        selectedItems.delete(id);
        el.classList.remove("selected");
      } else {
        selectedItems.add(id);
        el.classList.add("selected");
      }
      if(selectedItems.size){
        dispenseBtn.style.display = "block";
        dispenseBtn.textContent   = selectedItems.size===1 ? "Dispense Snack" : "Dispense Snacks";
      } else {
        dispenseBtn.style.display = "none";
      }
    }

    // ---------- Config Modal ----------
    const configModal = document.getElementById("configModal"),
          configInput = document.getElementById("configInput"),
          configSave  = document.getElementById("configSave"),
          configClose = document.getElementById("configClose");

    function openConfigModal(){
      db.ref("Config").once("value")
        .then(snap => configInput.value = snap.val()||"")
        .catch(e => console.error(e));
      configModal.style.display = "block";
    }
    configClose.addEventListener("click", ()=>configModal.style.display="none");
    configSave.addEventListener("click", async ()=>{
      const k = configInput.value.trim();
      if(!k) return alert("Enter a key");
      try {
        await db.ref("Config").set(k);
        alert("Saved!");
        configModal.style.display="none";
      } catch(e){
        console.error(e);
        alert("Error saving");
      }
    });

    // ---------- Show Key Modal ----------
    const showKeyModal  = document.getElementById("showKeyModal"),
          savedKeyText  = document.getElementById("savedKeyText"),
          showKeyClose  = document.getElementById("showKeyClose");

    function openShowKeyModal(){
      savedKeyText.textContent = localStorage.getItem("secretKey")||"(none)";
      showKeyModal.style.display="block";
    }
    showKeyClose.addEventListener("click", ()=>showKeyModal.style.display="none");

    // ---------- Dispense Flow ----------
    async function proceedToDispense(){
      if(!selectedItems.size) return;
      await sendDispenseSignal();
      showScreen("dispense-screen");
      initDispense();
    }

    function signOut(){
      clearInterval(countdownTimer);
      countdownValue = 5;
      showScreen("logo-screen");
    }

    // ---------- Send Data & Log (no key) ----------
    async function sendDispenseSignal(){
      if(!writeAllowed){
        console.warn("Write blocked");
        return;
      }
      const user = STUDENTS[studentId]||studentId;
      const data = { Status:true, User:user };
      snacks.forEach((s,i)=> data[`Item${i+1}`] = selectedItems.has(s.id));
      try {
        await db.ref("data").set(data);
      } catch(e){
        console.error("Data write error",e);
      }
      const now = new Date(),
            mm  = String(now.getMonth()+1).padStart(2,"0"),
            dd  = String(now.getDate()).padStart(2,"0"),
            yy  = String(now.getFullYear()).slice(-2),
            dateKey = `${mm}-${dd}-${yy}`,
            h   = now.getHours(),
            m   = String(now.getMinutes()).padStart(2,"0"),
            s   = String(now.getSeconds()).padStart(2,"0"),
            ap  = h>=12?"pm":"am", hr=h%12||12,
            time= `${hr}h:${m}m:${s}s${ap}`,
            payload=[];
      snacks.forEach((_,i)=> selectedItems.has(snacks[i].id) && payload.push(i+1));
      const log = { Time:time, User:user, Payload:payload.join(", ") };
      try {
        await db.ref(`Logs/${dateKey}`).push(log);
      } catch(e){
        console.error("Log write error",e);
      }
    }

    // ---------- Dispense Screen ----------
    const thankYouMsg = document.getElementById("thank-you-msg"),
          countdownEl  = document.getElementById("countdown"),
          stayBtn      = document.getElementById("stay-signed-btn");

    function setupDispense(){
      stayBtn.addEventListener("click", ()=>{
        clearInterval(countdownTimer);
        showScreen("snack-screen");
        initSnack();
      });
      window.addEventListener("keydown", e=>{
        if(currentScreen==="dispense"){
          if(e.key==="Enter"||e.key==="NumpadEnter"){
            clearInterval(countdownTimer);
            showScreen("snack-screen");
            initSnack();
          } else if(e.key==="Escape"){
            clearInterval(countdownTimer);
            signOut();
          } else {
            clearInterval(countdownTimer);
          }
        }
      });
    }

    function initDispense(){
      const user = STUDENTS[studentId]||studentId||"Student";
      thankYouMsg.textContent = `Thank you, ${user.split(" ")[0]}!`;
      countdownValue = 5;
      countdownEl.textContent = countdownValue;
      countdownTimer = setInterval(()=>{
        countdownValue--;
        countdownEl.textContent = countdownValue;
        if(countdownValue <= 0){
          clearInterval(countdownTimer);
          signOut();
        }
      },1000);
    }
  </script>
</body>
</html>
