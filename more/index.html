<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vending Machine</title>

  <!-- Firebase scripts (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* ---------------------------------------------------
       GLOBAL STYLES / RESETS
    --------------------------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background: white;
    }
    /* Hide all cursors (as requested) */
    html, body, button, a {
      cursor: none !important;
    }
    /* Basic button click effect */
    button {
      transition: transform 0.1s;
      user-select: none;
    }
    button:active {
      transform: scale(0.95);
    }

    /* ---------------------------------------------------
       APP CONTAINER & VERSION
    --------------------------------------------------- */
    #app {
      position: relative;
      width: 100%;
      height: 100%;
    }
    /* Version label in bottom-left corner */
    #version-label {
      position: fixed;
      bottom: 10px;
      left: 10px;
      font-size: 1em;
      color: #555;
      z-index: 9999;
    }

    /* Invisible Dev button at top-right */
    #devButton {
      position: fixed;
      top: 0;
      right: 0;
      width: 50px;
      height: 50px;
      background: transparent;
      border: none;
      cursor: pointer;
      opacity: 0;
      z-index: 9999;
    }

    /* ---------------------------------------------------
       SCREENS
       Each screen is absolutely positioned & centered
    --------------------------------------------------- */
    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      text-align: center;
      display: none;
    }
    .screen.active {
      display: block;
    }

    /* ---------------------------------------------------
       LOGO SCREEN
    --------------------------------------------------- */
    #logo-screen img {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      animation: pulse 2s infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    #logo-screen h2 {
      margin-top: 20px;
      font-size: 2.5em;
      color: #333;
    }

    /* ---------------------------------------------------
       KEYPAD SCREEN
    --------------------------------------------------- */
    #keypad-screen h2 {
      margin-bottom: 20px;
      font-size: 2.2em;
      color: #333;
    }
    #digit-display {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .digit-box {
      width: 70px;
      height: 70px;
      margin: 0 5px;
      border-bottom: 2px solid #333;
      font-size: 3em;
      line-height: 70px;
    }
    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      justify-items: center;
    }
    .keypad-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(0,0,0,0.1);
      color: #333;
      font-size: 2.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .keypad-btn.backspace {
      background: red;
      color: white;
    }
    /* Shake animation on invalid ID */
    .shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(10px); }
      100% { transform: translateX(0); }
    }

    /* ---------------------------------------------------
       SNACK SCREEN
    --------------------------------------------------- */
    /* Absolutely positioned so it doesn't overlap Keypad or Logo screens */
    #snack-screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      text-align: center;
      display: none;
      /* Provide top spacing for name/sign-out */
      padding-top: 100px;
    }
    #student-name {
      position: absolute;
      top: 10px;
      left: 20px;
      font-size: 2em;
      color: #333;
    }
    #snack-signout {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 1.8em;
      background: #e74c3c;
      border: none;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    #snack-screen h2 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #333;
    }
    /* Grid of snacks */
    #snack-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 120px; /* Leave space for the button */
      justify-items: center;
    }
    .snack-item {
      background: rgba(0,0,0,0.05);
      border: 2px solid transparent;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s;
      text-align: center;
    }
    .snack-item.selected {
      background: rgba(52, 152, 219, 0.4);
      border-color: #3498db;
    }
    .snack-item h4 {
      margin-bottom: 5px;
      font-size: 1.6em;
    }
    .snack-item p {
      font-size: 1.2em;
    }
    #dispense-button {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 25px 35px;
      font-size: 1.8em;
      background: #2ecc71;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: none;
    }

    /* ---------------------------------------------------
       DISPENSE SCREEN
    --------------------------------------------------- */
    #dispense-screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      text-align: center;
      display: none;
      background: rgba(0, 0, 139, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      color: white;
      padding: 30px;
    }
    #dispense-screen img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 15px;
    }
    #dispense-screen h2 {
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    #dispense-screen p {
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    #dispense-screen .stay-signed {
      padding: 15px 30px;
      background: #2980b9;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 1.5em;
    }

    /* ---------------------------------------------------
       MOBILE ADJUSTMENTS
    --------------------------------------------------- */
    @media (max-width: 600px) {
      #logo-screen img {
        width: 250px;
        height: 250px;
      }
      #logo-screen h2 {
        font-size: 2.2em;
      }
      .digit-box {
        width: 80px;
        height: 80px;
        font-size: 3.5em;
        line-height: 80px;
      }
      .keypad-btn {
        width: 90px;
        height: 90px;
        font-size: 2.2em;
      }
      #student-name {
        font-size: 1.8em;
      }
      #snack-signout {
        font-size: 1.5em;
      }
      #snack-screen h2 {
        font-size: 2.2em;
      }
      .snack-item h4 {
        font-size: 1.8em;
      }
      #dispense-button {
        font-size: 2em;
        padding: 30px 40px;
      }
      #dispense-screen h2,
      #dispense-screen p {
        font-size: 1.8em;
      }
      #dispense-screen .stay-signed {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    
    <!-- Invisible dev button (top-right) -->
    <button id="devButton"></button>
    
    <!-- LOGO SCREEN -->
    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo" />
      <h2>Tap to Begin</h2>
    </div>
    
    <!-- KEYPAD SCREEN -->
    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons">
        <!-- Keypad buttons built dynamically -->
      </div>
    </div>
    
    <!-- SNACK SCREEN -->
    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button class="sign-out" id="snack-signout">Sign Out</button>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>
    
    <!-- DISPENSE SCREEN -->
    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo" />
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-info">
        <h3 id="dispense-text">Your snack(s) will be dispensed shortly</h3>
        <p>Signing you out in <span id="countdown">5</span></p>
      </div>
      <button class="stay-signed" id="stay-signed-btn">Stay Signed In</button>
    </div>
    
    <!-- VERSION LABEL -->
    <div id="version-label">v2.4.2</div>
  </div>

  <script>
    /* ------------------- FIREBASE INIT ------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
      authDomain: "cyberflashvend.firebaseapp.com",
      databaseURL: "https://cyberflashvend-default-rtdb.firebaseio.com",
      projectId: "cyberflashvend",
      storageBucket: "cyberflashvend.firebasestorage.app",
      messagingSenderId: "63786658773",
      appId: "1:63786658773:web:7792d3693ef45e9ec4eb5c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ------------------- GLOBALS ------------------- */
    let currentScreen = "logo";        // "logo", "keypad", "snack", "dispense"
    let studentId = "";               // The user PIN
    let selectedItems = new Set();    // Tracks selected snacks
    let countdownTimer = null;        // For the "signing out" countdown
    let countdownValue = 5;           // Starting countdown value
    let idleTimer = null;             // Auto-logout after inactivity

    /* ------------------- STUDENT DATA (PIN) ------------------- */
    const STUDENTS = {
      "260514": "Gavin Molter",
      "250257": "Amit Ghumaan",
      "251022": "Sun Bawi",
      "250202": "Mitchell Douglass",
      "250298": "Heyden Halstead",
      "270391": "Nate Jones",
      "280335": "Calli Justice",
      "260913": "Levi Kane",
      "280508": "Colden Oakley",
      "250606": "Madeline Penney",
      "250639": "Rohan Rajanahalli",
      "260627": "Mason Robbins"
    };

    /* ------------------- SNACK DATA ------------------- */
    const snacks = [
      { id: "A1", name: "Chips", quantity: 8 },
      { id: "A2", name: "Cookies", quantity: 5 },
      { id: "A3", name: "Pretzels", quantity: 12 },
      { id: "B1", name: "Candy Bar", quantity: 7 },
      { id: "B2", name: "Granola Bar", quantity: 3 },
      { id: "B3", name: "Trail Mix", quantity: 9 }
    ];

    /* ------------------- IDLE TIMER (90s) ------------------- */
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        signOut(); // auto-logout after 90s inactivity
      }, 90 * 1000);
    }
    document.addEventListener("keydown", resetIdleTimer);
    document.addEventListener("click", resetIdleTimer);
    document.addEventListener("mousemove", resetIdleTimer);
    document.addEventListener("touchstart", resetIdleTimer);
    resetIdleTimer();

    /* ------------------- SCREEN NAVIGATION ------------------- */
    function showScreen(screenId) {
      // Hide all screens
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      // Show the desired screen
      document.getElementById(screenId).classList.add("active");
      currentScreen = screenId.split("-")[0];

      // Disable dev button if user is signed in or if not on the logo screen
      if (currentScreen !== "logo" || studentId !== "") {
        devButton.disabled = true;
        devButton.style.pointerEvents = "none";
      } else {
        devButton.disabled = false;
        devButton.style.pointerEvents = "auto";
      }
    }

    /* ------------------- DEV BUTTON (INVISIBLE) ------------------- */
    const devButton = document.getElementById("devButton");
    devButton.addEventListener("click", () => {
      studentId = "DEV MODE";
      document.getElementById("student-name").textContent = "DEV MODE";
      showScreen("snack-screen");
      initSnackScreen();
    });

    /* ------------------- LOGO SCREEN ------------------- */
    const logoScreen = document.getElementById("logo-screen");
    logoScreen.addEventListener("click", () => {
      showScreen("keypad-screen");
      initKeypad();
    });
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "logo") {
        showScreen("keypad-screen");
        initKeypad();
      }
    });

    /* ------------------- KEYPAD SCREEN ------------------- */
    const digitDisplay = document.getElementById("digit-display");
    const keypadButtons = document.getElementById("keypad-buttons");
    const maxDigits = 6;

    // Check both top row & numpad
    function isNumberKey(e) {
      return (
        (e.key >= "0" && e.key <= "9") ||               // top row
        (e.code.startsWith("Numpad") && e.key.length === 1) // numpad
      );
    }

    // Layout for keypad
    const keypadLayout = [
      "1","2","3",
      "4","5","6",
      "7","8","9",
      "", "0", "backspace"
    ];

    function initKeypad() {
      studentId = "";
      renderDigits();
      // If keypad isn't built yet, build it
      if (keypadButtons.children.length === 0) {
        keypadLayout.forEach((val) => {
          if (val === "") {
            // Empty placeholder
            const placeholder = document.createElement("div");
            placeholder.style.width = "100px";
            placeholder.style.height = "100px";
            keypadButtons.appendChild(placeholder);
          } else {
            const btn = document.createElement("div");
            btn.classList.add("keypad-btn");
            if (val === "backspace") {
              btn.classList.add("backspace");
              btn.textContent = "←";
              btn.addEventListener("click", handleBackspace);
            } else {
              btn.textContent = val;
              btn.addEventListener("click", () => handleDigitInput(val));
            }
            keypadButtons.appendChild(btn);
          }
        });
      }
    }

    function renderDigits() {
      digitDisplay.innerHTML = "";
      for (let i = 0; i < maxDigits; i++) {
        const box = document.createElement("div");
        box.classList.add("digit-box");
        box.textContent = (i < studentId.length) ? "•" : "_";
        digitDisplay.appendChild(box);
      }
    }

    function handleDigitInput(digit) {
      if (studentId.length < maxDigits) {
        studentId += digit;
        renderDigits();
        if (studentId.length === maxDigits) {
          validateStudentId();
        }
      }
    }

    function handleBackspace() {
      if (studentId.length > 0) {
        studentId = studentId.slice(0, -1);
        renderDigits();
      }
    }

    window.addEventListener("keydown", (e) => {
      if (currentScreen === "keypad") {
        if (isNumberKey(e)) {
          // last character is the digit
          let pressedDigit = e.key[e.key.length-1];
          handleDigitInput(pressedDigit);
        } else if (e.key === "Backspace") {
          handleBackspace();
        } else if ((e.key === "Enter" || e.key === "NumpadEnter") && studentId.length === maxDigits) {
          validateStudentId();
        }
      }
    });

    function validateStudentId() {
      if (STUDENTS[studentId]) {
        // Valid ID
        document.getElementById("student-name").textContent = STUDENTS[studentId];
        showScreen("snack-screen");
        initSnackScreen();
      } else {
        // Invalid ID => shake & reset
        digitDisplay.classList.add("shake");
        setTimeout(() => {
          digitDisplay.classList.remove("shake");
          studentId = "";
          renderDigits();
        }, 500);
      }
    }

    /* ------------------- SNACK SCREEN ------------------- */
    const snackGrid = document.getElementById("snack-grid");
    const dispenseButton = document.getElementById("dispense-button");
    const snackSignOut = document.getElementById("snack-signout");

    function initSnackScreen() {
      selectedItems.clear();
      renderSnackGrid();
      dispenseButton.style.display = "none";
    }

    function renderSnackGrid() {
      snackGrid.innerHTML = "";
      snacks.forEach((snack) => {
        const snackDiv = document.createElement("div");
        snackDiv.classList.add("snack-item");
        snackDiv.innerHTML = `
          <h4>${snack.name}</h4>
          <p>ID: ${snack.id} | Qty: ${snack.quantity}</p>
        `;
        snackDiv.addEventListener("click", () => toggleSnackSelection(snack.id, snackDiv));
        snackGrid.appendChild(snackDiv);
      });
    }

    function toggleSnackSelection(snackId, element) {
      if (selectedItems.has(snackId)) {
        selectedItems.delete(snackId);
        element.classList.remove("selected");
      } else {
        selectedItems.add(snackId);
        element.classList.add("selected");
      }
      // Show/hide the Dispense button
      if (selectedItems.size > 0) {
        dispenseButton.style.display = "block";
        dispenseButton.textContent = (selectedItems.size === 1) ? "Dispense Snack" : "Dispense Snacks";
      } else {
        dispenseButton.style.display = "none";
      }
    }

    // Let user pick items & press Enter
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "snack") {
        if (isNumberKey(e)) {
          // Key 1..6 => toggle items 1..6
          let digit = +e.key[e.key.length-1];
          let idx = digit - 1;
          if (idx >= 0 && idx < snacks.length) {
            const snackId = snacks[idx].id;
            const snackDiv = snackGrid.children[idx];
            toggleSnackSelection(snackId, snackDiv);
          }
        } else if ((e.key === "Enter" || e.key === "NumpadEnter") && selectedItems.size > 0) {
          proceedToDispense();
        } else if (e.key === "Escape") {
          signOut();
        }
      }
    });

    dispenseButton.addEventListener("click", proceedToDispense);
    snackSignOut.addEventListener("click", signOut);

    /* ------------------- FIREBASE: SEND SIGNAL & LOGS ------------------- */
    async function sendDispenseSignal() {
      // Construct /data payload
      const userName = STUDENTS[studentId] || studentId;
      let dataPayload = { 
        Status: true,
        User: userName
      };
      snacks.forEach((snack, i) => {
        dataPayload[`Item${i+1}`] = selectedItems.has(snack.id);
      });

      // Write /data
      try {
        await db.ref("data").set(dataPayload);
        console.log("Firebase => /data set:", dataPayload);
      } catch (err) {
        console.error("Error writing /data:", err);
      }

      // Create log entry => /Logs
      const now = new Date();
      const mon = String(now.getMonth()+1).padStart(2,'0');
      const day = String(now.getDate()).padStart(2,'0');
      const yr = String(now.getFullYear()).slice(-2);
      const dateKey = `${mon}-${day}-${yr}`;

      const hours = now.getHours();
      const minutes = String(now.getMinutes()).padStart(2,'0');
      const seconds = String(now.getSeconds()).padStart(2,'0');
      const ampm = hours >= 12 ? "pm" : "am";
      const hour = hours % 12 === 0 ? 12 : (hours % 12);
      const timeString = `${hour}h:${minutes}m:${seconds}s${ampm}`;

      const payloadArr = [];
      snacks.forEach((snack, idx) => {
        if (selectedItems.has(snack.id)) payloadArr.push(idx+1);
      });

      const logEntry = {
        Time: timeString,
        User: userName,
        Payload: payloadArr.join(", ")
      };
      try {
        const logRef = await db.ref(`Logs/${dateKey}`).push(logEntry);
        console.log("Firebase => /Logs entry added:", logEntry, "key=", logRef.key);
      } catch (err) {
        console.error("Error writing /Logs:", err);
      }
    }

    /* ------------------- DISPENSE FLOW ------------------- */
    function proceedToDispense() {
      // 1) Write to Firebase
      sendDispenseSignal().then(() => {
        // 2) Show Dispense screen
        showScreen("dispense-screen");
        initDispenseScreen();
      });
    }

    function signOut() {
      clearInterval(countdownTimer);
      countdownValue = 5;
      showScreen("logo-screen");
      console.log("Signed out => returning to logo screen.");
    }

    /* ------------------- DISPENSE SCREEN ------------------- */
    const thankYouMsg = document.getElementById("thank-you-msg");
    const countdownEl = document.getElementById("countdown");
    const staySignedBtn = document.getElementById("stay-signed-btn");

    function initDispenseScreen() {
      const userName = STUDENTS[studentId] || studentId || "Student";
      const firstName = userName.split(" ")[0];
      thankYouMsg.textContent = `Thank you, ${firstName}!`;
      countdownValue = 5;
      countdownEl.textContent = countdownValue;
      startCountdown();
    }

    function startCountdown() {
      countdownTimer = setInterval(() => {
        countdownValue--;
        countdownEl.textContent = countdownValue;
        if (countdownValue <= 0) {
          clearInterval(countdownTimer);
          signOut();
        }
      }, 1000);
    }

    staySignedBtn.addEventListener("click", () => {
      clearInterval(countdownTimer);
      showScreen("snack-screen");
      initSnackScreen();
    });

    window.addEventListener("keydown", (e) => {
      if (currentScreen === "dispense") {
        // Enter => back to snack screen
        if (e.key === "Enter" || e.key === "NumpadEnter") {
          clearInterval(countdownTimer);
          showScreen("snack-screen");
          initSnackScreen();
        }
        // Escape => sign out
        else if (e.key === "Escape") {
          clearInterval(countdownTimer);
          signOut();
        }
        // Any other key => stop countdown
        else {
          clearInterval(countdownTimer);
        }
      }
    });
  </script>
</body>
</html>
