<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { width:100%; height:100%; font-family:Arial,sans-serif; background:#fff; }
    html, body, button, a { cursor: none !important; }
    button { transition:transform .1s; user-select:none; }
    button:active { transform:scale(.95); }

    /* APP & VERSION */
    #app { position:relative; width:100%; height:100%; }
    #version-label { position:fixed; bottom:10px; left:10px; color:#555; z-index:9999; }
    #devButton { position:fixed; top:0; right:0; width:50px; height:50px; background:transparent; border:none; opacity:0; z-index:9999; }

    /* SCREENS */
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:800px; text-align:center; display:none; }
    .screen.active { display:block; }

    /* LOGO */
    #logo-screen img {
      width:300px; height:300px; border-radius:50%;
      box-shadow:0 0 20px rgba(0,0,0,.5);
      animation:pulse 2s infinite alternate;
      cursor:pointer;
    }
    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.05)}}
    #logo-screen h2{margin-top:20px;font-size:2.5em;color:#333;}

    /* KEYPAD */
    #keypad-screen h2{margin-bottom:20px;font-size:2.2em;color:#333;}
    #digit-display{display:flex;justify-content:center;margin-bottom:20px;}
    .digit-box{width:70px;height:70px;margin:0 5px;border-bottom:2px solid #333;font-size:3em;line-height:70px;}
    .keypad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;justify-items:center;}
    .keypad-btn{width:100px;height:100px;border-radius:50%;background:rgba(0,0,0,.1);color:#333;font-size:2.5em;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .keypad-btn.backspace{background:red;color:#fff;}
    .shake{animation:shake .5s;}
    @keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}100%{transform:translateX(0)}}

    /* SNACK */
    #snack-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:800px;padding-top:100px;text-align:center;}
    #student-name{position:absolute;top:10px;left:20px;font-size:2em;color:#333;}
    #snack-signout,#openConfigBtn,#openShowKeyBtn{position:absolute;top:10px;padding:8px 12px;border:none;border-radius:4px;font-size:0.9em;cursor:pointer;}
    #snack-signout{right:20px;background:#e74c3c;color:#fff;}
    #openConfigBtn{left:50%;transform:translateX(-150%);background:#007bff;color:#fff;}
    #openShowKeyBtn{left:50%;transform:translateX(50%);background:#007bff;color:#fff;}
    #snack-screen h2{font-size:2.5em;margin-bottom:30px;color:#333;display:inline-block;}
    .receipt-btn{display:inline-block;margin-left:10px;width:40px;height:40px;border-radius:50%;background:#007bff;color:#fff;font-size:1.5em;line-height:40px;cursor:pointer;vertical-align:middle;}
    #snack-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;margin-bottom:120px;justify-items:center;}
    .snack-item{background:rgba(0,0,0,.05);border:2px solid transparent;padding:15px;border-radius:8px;cursor:pointer;transition:background .3s,border-color .3s;text-align:center;}
    .snack-item.selected{background:rgba(52,152,219,.4);border-color:#3498db;}
    .snack-item h4{margin-bottom:5px;font-size:1.6em;}
    .snack-item p{font-size:1.2em;}
    #dispense-button{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);padding:25px 35px;font-size:1.8em;background:#2ecc71;border:none;border-radius:8px;color:#fff;cursor:pointer;display:none;}

    /* TRANSACTIONS MODAL */
    #userModal,#transModal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;padding:20px;background:#fefefe;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.2);z-index:10000;}
    .modal-header{margin-bottom:15px;font-size:1.4em;font-weight:bold;}
    .modal-body{max-height:300px;overflow-y:auto;margin-bottom:15px;}
    .modal-footer{text-align:right;}
    .modal-footer button{margin-left:8px;}
    .txn-item{padding:8px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;}
    .txn-item:last-child{border:none;}
    .delete-btn{background:#e74c3c;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;}

    /* TOAST */
    #toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;}
    .toast{display:inline-block;background:rgba(0,0,0,.8);color:#fff;padding:10px 20px;margin-top:10px;border-radius:4px;opacity:0;animation:fadein .3s forwards,fadeout .3s forwards 2.7s;}
    @keyframes fadein{to{opacity:1;}}@keyframes fadeout{to{opacity:0;}}

    /* MOBILE */
    @media(max-width:600px){#snack-screen h2{display:block;}.receipt-btn{margin:10px auto;}#userModal,#transModal{width:90%;}}
  </style>
</head>
<body>
  <div id="app">
    <button id="devButton"></button>

    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo" />
      <h2>Tap to Begin</h2>
    </div>

    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons"></div>
    </div>

    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button id="snack-signout">Sign Out</button>
      <button id="openConfigBtn">Set Local Key</button>
      <button id="openShowKeyBtn">View Local Key</button>
      <h2>Select a Snack</h2>
      <div class="receipt-btn" id="viewTxnBtn">ðŸ“„</div>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>

    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo" />
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-text">Your snack(s) will be dispensed shortly</div>
      <p>Signing you out in <span id="countdown">5</span></p>
      <button id="stay-signed-btn">Stay Signed In</button>
    </div>

    <div id="configModal" class="modal screen">
      <div class="modal-header">Set Local Secret Key</div>
      <div class="modal-body"><input id="configInput" placeholder="New local key" /></div>
      <div class="modal-footer">
        <button id="configClose">Close</button>
        <button id="configSave">Save</button>
      </div>
    </div>

    <div id="showKeyModal" class="modal screen">
      <div class="modal-header">Local Secret Key</div>
      <div class="modal-body"><strong id="savedKeyText"></strong></div>
      <div class="modal-footer"><button id="showKeyClose">Close</button></div>
    </div>

    <div id="userModal" class="modal screen">
      <div class="modal-header">Select User</div>
      <div class="modal-body" id="userList"></div>
      <div class="modal-footer"><button id="userModalClose">Close</button></div>
    </div>

    <div id="transModal" class="modal screen">
      <div class="modal-header">Transactions</div>
      <div class="modal-body" id="txnList"></div>
      <div class="modal-footer"><button id="transModalClose">Close</button></div>
    </div>

    <div id="toast-container"></div>
    <div id="version-label"></div>
  </div>

  <script>
    // full JS definitions
    const APP_VERSION="v2.6.6";
    const cfg={apiKey:"AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",authDomain:"cyberflashvend.firebaseapp.com",databaseURL:"https://cyberflashvend-default-rtdb.firebaseio.com",projectId:"cyberflashvend",storageBucket:"cyberflashvend.firebasestorage.app",messagingSenderId:"63786658773",appId:"1:63786658773:web:7792d3693ef45e9ec4eb5c"};
    firebase.initializeApp(cfg);
    const db=firebase.database();
    let serverSecret=null;
    async function checkSecret(){
      try{serverSecret=(await db.ref("Config").once("value")).val();}catch(e){console.error(e);}initApp();
    }
    checkSecret();

    // globals
    let currentScreen="logo",studentId="",selectedItems=new Set(),idleTimer,countdownTimer,countdownValue=5;
    const STUDENTS={"260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi","250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones","280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley","250606":"Madeline Penney","250639":"Rohan Rajanahalli","260627":"Mason Robbins"};
    const snacks=[{id:"A1",name:"Chips",quantity:8},{id:"A2",name:"Cookies",quantity:5},{id:"A3",name:"Pretzels",quantity:12},{id:"B1",name:"Candy Bar",quantity:7},{id:"B2",name:"Granola Bar",quantity:3},{id:"B3",name:"Trail Mix",quantity:9}];

    function resetIdle(){clearTimeout(idleTimer);idleTimer=setTimeout(signOut,90*1000);}[
      "keydown","click","mousemove","touchstart"
    ].forEach(e=>document.addEventListener(e,resetIdle));resetIdle();

    function showScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentScreen=id.split("-")[0];
      if(currentScreen!=="logo"||studentId!=""){devButton.disabled=true;devButton.style.pointerEvents="none";}else{devButton.disabled=false;devButton.style.pointerEvents="auto";}
    }

    function initApp(){
      document.getElementById("version-label").textContent=APP_VERSION;
      setupDevKey();setupLogo();setupKeypad();setupSnack();setupDispense();setupModals();
    }

    function showToast(msg){
      const t=document.createElement("div");t.className="toast";t.textContent=msg;
      document.getElementById("toast-container").appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    function enableCursor(){
      if(document.getElementById("cursorOverride"))return;
      const s=document.createElement("style");s.id="cursorOverride";
      s.innerHTML="html,body,button,a{cursor:auto!important}";
      document.head.appendChild(s);
    }

    // signOut must be declared early
    function signOut(){clearInterval(countdownTimer);countdownValue=5;showScreen("logo-screen");}

    const devButton=document.getElementById("devButton");
    function setupDevKey(){window.addEventListener("keydown",e=>{if(e.key.toLowerCase()==="d")activateDev();});devButton.addEventListener("click",activateDev);}    
    function activateDev(){studentId="DEV MODE";document.getElementById("student-name").textContent="DEV MODE";showScreen("snack-screen");initSnack();enableCursor();}

    function setupLogo(){const logo=document.getElementById("logo-screen");logo.addEventListener("click",()=>{showScreen("keypad-screen");initKeypad();});window.addEventListener("keydown",e=>{if(currentScreen==="logo"){showScreen("keypad-screen");initKeypad();}});}    

    // keypad
    const digitDisplay=document.getElementById("digit-display"),keypadButtons=document.getElementById("keypad-buttons"),maxDigits=6;
    function isNumKey(e){return(e.key>="0"&&e.key<="9")||(e.code.startsWith("Numpad")&&e.key.length===1);}
    const layout=["1","2","3","4","5","6","7","8","9","","0","backspace"];
    function setupKeypad(){initKeypad();window.addEventListener("keydown",e=>{if(currentScreen==="keypad"&&!e.repeat){if(isNumKey(e)){e.preventDefault();handleDigit(e.key.slice(-1));}else if(e.key==="Backspace"){e.preventDefault();handleBack();}else if((e.key==="Enter"||e.key==="NumpadEnter")&&studentId.length===maxDigits){e.preventDefault();validateID();}}});}
    function initKeypad(){studentId="";renderDigits();if(!keypadButtons.children.length){layout.forEach(val=>{if(!val){const ph=document.createElement("div");ph.style.width="100px";ph.style.height="100px";keypadButtons.appendChild(ph);}else{const btn=document.createElement("div");btn.classList.add("keypad-btn");if(val==="backspace"){btn.classList.add("backspace");btn.textContent="â†";btn.addEventListener("click",handleBack);}else{btn.textContent=val;btn.addEventListener("click",()=>handleDigit(val));}keypadButtons.appendChild(btn);}});} }
    function renderDigits(){digitDisplay.innerHTML="";for(let i=0;i<maxDigits;i++){const d=document.createElement("div");d.classList.add("digit-box");d.textContent=i<studentId.length?"â€¢":"_";digitDisplay.appendChild(d);} }
    function handleDigit(ch){if(studentId.length<maxDigits){studentId+=ch;renderDigits();if(studentId.length===maxDigits)validateID();}}    
    function handleBack(){if(studentId.length){studentId=studentId.slice(0,-1);renderDigits();}}    
    function validateID(){if(STUDENTS[studentId]){document.getElementById("student-name").textContent=STUDENTS[studentId];showScreen("snack-screen");initSnack();}else{digitDisplay.classList.add("shake");setTimeout(()=>{digitDisplay.classList.remove("shake");studentId="";renderDigits();},500);showToast("Invalid ID");}}    

    // snack
    const snackGrid=document.getElementById("snack-grid"),dispenseBtn=document.getElementById("dispense-button"),signOutBtn=document.getElementById("snack-signout"),cfgBtn=document.getElementById("openConfigBtn"),showBtn=document.getElementById("openShowKeyBtn"),viewTxnBtn=document.getElementById("viewTxnBtn");
    function setupSnack(){signOutBtn.addEventListener("click",signOut);dispenseBtn.addEventListener("click",proceedToDispense);cfgBtn.addEventListener("click",openConfigModal);showBtn.addEventListener("click",openShowKeyModal);viewTxnBtn.addEventListener("click",openTxnFlow);window.addEventListener("keydown",e=>{if(currentScreen==="snack"&&!e.repeat){if(isNumKey(e)){const i=+e.key.slice(-1)-1;if(i>=0&&i<snacks.length)toggleSnack(snacks[i].id,snackGrid.children[i]);}else if((e.key==="Enter"||e.key==="NumpadEnter")&&selectedItems.size){proceedToDispense();}else if(e.key==="Escape"){signOut();}else if(e.key.toLowerCase()==="r"){openTxnFlow();}}});}
    function initSnack(){selectedItems.clear();snackGrid.innerHTML="";snacks.forEach(s=>{const d=document.createElement("div");d.classList.add("snack-item");d.innerHTML=`<h4>${s.name}</h4><p>ID: ${s.id} | Qty: ${s.quantity}</p>`;d.addEventListener("click",()=>toggleSnack(s.id,d));snackGrid.appendChild(d);});dispenseBtn.style.display="none";cfgBtn.style.display=showBtn.style.display=(studentId==="DEV MODE"?"block":"none");}
    function toggleSnack(id,el){if(selectedItems.has(id)){selectedItems.delete(id);el.classList.remove("selected");}else{selectedItems.add(id);el.classList.add("selected");}if(selectedItems.size){dispenseBtn.style.display="block";dispenseBtn.textContent=selectedItems.size===1?"Dispense Snack":"Dispense Snacks";}else{dispenseBtn.style.display="none";}}

    // config
    const configModal=document.getElementById("configModal"),configInput=document.getElementById("configInput"),configSave=document.getElementById("configSave"),configClose=document.getElementById("configClose"),showKeyModal=document.getElementById("showKeyModal"),showKeyClose=document.getElementById("showKeyClose"),savedKeyText=document.getElementById("savedKeyText");
    function setupModals(){configClose.onclick=()=>configModal.style.display="none";configSave.onclick=saveLocalKey;configInput.onkeydown=e=>{if(e.key==="Enter")saveLocalKey();};showKeyClose.onclick=()=>showKeyModal.style.display="none";userModalClose.onclick=()=>userModal.style.display="none";transModalClose.onclick=()=>transModal.style.display="none";}
    function saveLocalKey(){const k=configInput.value.trim();if(!k){showToast("Please enter a key");return;}localStorage.setItem("secretKey",k);showToast("Local key updated");configModal.style.display="none";}
    function openConfigModal(){configInput.value=localStorage.getItem("secretKey")||"";configModal.style.display="block";}
    function openShowKeyModal(){savedKeyText.textContent=localStorage.getItem("secretKey")||"(none)";showKeyModal.style.display="block";}

    // dispense
    async function proceedToDispense(){if(!selectedItems.size)return;await sendDispenseSignal();showScreen("dispense-screen");initDispense();}

    async function sendDispenseSignal(){const localKey=localStorage.getItem("secretKey");if(localKey!==serverSecret){showToast("Unauthorized");return;}const user=STUDENTS[studentId]||studentId, data={Status:true,User:user};snacks.forEach((s,i)=>data[`Item${i+1}`]=selectedItems.has(s.id));try{await db.ref("data").update(data);}catch(e){console.error(e);}const now=new Date(),mm=("0"+(now.getMonth()+1)).slice(-2),dd=("0"+now.getDate()).slice(-2),yy=(""+now.getFullYear()).slice(-2).slice(-2),key=`${mm}-${dd}-${yy}`,h=now.getHours(),m=("0"+now.getMinutes()).slice(-2),s=("0"+now.getSeconds()).slice(-2),ap=h>=12?"pm":"am",hr=h%12||12,time=`${hr}h:${m}m:${s}s${ap}`,payload=[];snacks.forEach((_,i)=>selectedItems.has(snacks[i].id)&&payload.push(i+1));const log={Time:time,User:user,Payload:payload.join(", ")};try{await db.ref(`Logs/${key}`).push(log);}catch(e){console.error(e);} }

    // transactions
    const userModal=document.getElementById("userModal"),userList=document.getElementById("userList"),userModalClose=document.getElementById("userModalClose"),transModal=document.getElementById("transModal"),txnList=document.getElementById("txnList"),transModalClose=document.getElementById("transModalClose");
    function openTxnFlow(){if(studentId==="DEV MODE"){openUserSelect();}else{fetchAndShowTxns(studentId);}}
    async function openUserSelect(){userList.innerHTML="";userModal.style.display="block";const snap=await db.ref("Logs").once("value"),users=new Set();snap.forEach(d=>d.forEach(tx=>users.add(tx.val().User)));users.forEach(u=>{const btn=document.createElement("div");btn.textContent=u;btn.style.padding="8px";btn.style.cursor="pointer";btn.onclick=()=>{userModal.style.display="none";fetchAndShowTxns(u);};userList.appendChild(btn);});}
    async function fetchAndShowTxns(user){txnList.innerHTML="";transModal.style.display="block";const snap=await db.ref("Logs").once("value");snap.forEach((d,dKey)=>{d.forEach(txSnap=>{const tx=txSnap.val();if(tx.User===user){const div=document.createElement("div");div.className="txn-item";div.innerHTML=`<span>${dKey} ${tx.Time}: ${tx.Payload}</span>`;if(studentId==="DEV MODE"){const del=document.createElement("button");del.className="delete-btn";del.textContent="Delete";del.onclick=async()=>{const pin=prompt("Enter delete PIN:");if(pin!="69420"){showToast("Wrong PIN");return;}await db.ref(`Logs/${dKey}/${txSnap.key}`).remove();div.remove();showToast("Deleted");};div.appendChild(del);}txnList.appendChild(div);}});} }

    // dispense screen
    const thankYouMsg=document.getElementById("thank-you-msg"),countdownEl=document.getElementById("countdown"),stayBtn=document.getElementById("stay-signed-btn");
    function setupDispense(){stayBtn.addEventListener("click",()=>{clearInterval(countdownTimer);showScreen("snack-screen");initSnack();});window.addEventListener("keydown",e=>{if(currentScreen==="dispense"){if(e.key==="Enter"||e.key==="NumpadEnter"){clearInterval(countdownTimer);showScreen("snack-screen");initSnack();}else if(e.key==="Escape"){clearInterval(countdownTimer);signOut();}else{clearInterval(countdownTimer);}}});}
    function initDispense(){const user=STUDENTS[studentId]||studentId||"Student";thankYouMsg.textContent=`Thank you, ${user.split(" ")[0]}!`;countdownValue=5;countdownEl.textContent=countdownValue;countdownTimer=setInterval(()=>{countdownValue--;countdownEl.textContent=countdownValue;if(countdownValue<=0){clearInterval(countdownTimer);signOut();}},1000);}

    // initialize all
    initApp();
  </script>
</body>
</html>
