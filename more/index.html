<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vending Machine</title>
  <style>
    /* Global Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    /* Hide cursor everywhere */
    html, body, button, a {
      cursor: none !important;
    }

    /* Button clicking effect */
    button {
      transition: transform 0.1s ease-in-out;
      user-select: none;
    }
    button:active {
      transform: scale(0.95);
    }
    
    /* App Container - White background */
    #app {
      position: relative;
      width: 100%;
      height: 100%;
      background: white;
    }

    /* Invisible Dev Button in top-right corner */
    #devButton {
      position: fixed;
      top: 0;
      right: 0;
      width: 50px;
      height: 50px;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 9999;
      opacity: 0; /* invisible */
    }

    /* Screen Base Class */
    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      text-align: center;
      display: none;
    }
    .active {
      display: block;
    }
    
    /* Logo Screen */
    #logo-screen {
      position: relative;
    }
    #logo-screen img {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      animation: pulse 2s infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    #logo-screen h2 {
      margin-top: 20px;
      font-size: 2.5em;
      color: #333;
    }
    
    /* Keypad Screen */
    #keypad-screen h2 {
      margin-bottom: 20px;
      font-size: 2.2em;
      color: #333;
    }
    #digit-display {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .digit-box {
      width: 70px;
      height: 70px;
      margin: 0 5px;
      border-bottom: 2px solid #333;
      font-size: 3em;
      line-height: 70px;
    }
    
    /* Keypad Grid - 3 columns, 4 rows */
    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      justify-items: center;
    }
    .keypad-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(0,0,0,0.1);
      color: #333;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    /* Special styling for backspace */
    .keypad-btn.backspace {
      background: red;
      color: white;
      font-size: 2.2em;
    }

    /* Shake animation when ID is invalid */
    .shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(10px); }
      100% { transform: translateX(0); }
    }
    
    /* Snack Screen */
    #snack-screen {
      position: relative;
      padding-top: 120px; /* ensure heading is below top elements */
    }
    /* User Name at top-left */
    #student-name {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 2em;
      color: #333;
    }
    /* Sign Out button at top-right */
    #snack-signout {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.8em;
      background: #e74c3c;
      border: none;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    #snack-screen h2 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #333;
    }
    #snack-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 100px; /* space for the dispense button */
    }
    .snack-item {
      background: rgba(0,0,0,0.05);
      border: 2px solid transparent;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s;
    }
    .snack-item.selected {
      background: rgba(52, 152, 219, 0.4);
      border-color: #3498db;
    }
    .snack-item img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .snack-item h4 {
      margin-bottom: 5px;
      font-size: 1.6em;
    }
    .snack-item p {
      font-size: 1.2em;
    }
    /* Dispense button centered at bottom */
    #dispense-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 25px 35px;
      font-size: 1.8em;
      background: #2ecc71;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: none;
    }
    
    /* Dispense Screen */
    #dispense-screen {
      max-width: 600px;
      padding: 30px;
      background: rgba(0, 0, 139, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      color: white;
    }
    #dispense-screen img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 15px;
    }
    #dispense-screen h2 {
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    #dispense-screen p {
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    #dispense-screen .stay-signed {
      padding: 15px 30px;
      background: #2980b9;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 1.5em;
    }
    
    /* Mobile Adjustments */
    @media (max-width: 600px) {
      #logo-screen img {
        width: 250px;
        height: 250px;
      }
      #logo-screen h2 {
        font-size: 2.2em;
      }
      .digit-box {
        width: 80px;
        height: 80px;
        font-size: 3.5em;
        line-height: 80px;
      }
      .keypad-btn {
        width: 90px;
        height: 90px;
        font-size: 2.2em;
      }
      #student-name {
        font-size: 1.8em;
      }
      #snack-signout {
        font-size: 1.5em;
      }
      #snack-screen h2 {
        font-size: 2.2em;
      }
      .snack-item img {
        width: 110px;
        height: 110px;
      }
      .snack-item h4 {
        font-size: 1.8em;
      }
      #dispense-button {
        font-size: 2em;
        padding: 30px 40px;
      }
      #dispense-screen h2,
      #dispense-screen p {
        font-size: 1.8em;
      }
      #dispense-screen .stay-signed {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Invisible Dev Button -->
    <button id="devButton"></button>

    <!-- Logo Screen -->
    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo">
      <h2>Tap to Begin</h2>
    </div>
    
    <!-- Keypad Screen -->
    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons">
        <!-- Created dynamically -->
      </div>
    </div>
    
    <!-- Snack Screen -->
    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button class="sign-out" id="snack-signout">Sign Out</button>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>
    
    <!-- Dispense Screen -->
    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo">
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-info">
         <h3 id="dispense-text">Your snack(s) will be dispensed shortly</h3>
         <p>Signing you out in <span id="countdown">5</span></p>
      </div>
      <button class="stay-signed" id="stay-signed-btn">Stay Signed In</button>
    </div>
  </div>

  <script>
    // ----- State Variables -----
    let currentScreen = "logo"; // "logo", "keypad", "snack", "dispense"
    let studentId = "";
    let selectedItems = new Set();
    let countdownTimer = null;
    let countdownValue = 5;
    let idleTimer = null;
    
    // ----- Data -----
    const STUDENTS = {
      "260514": "Gavin Molter",
      "250257": "Amit Ghumaan",
      "251022": "Sun Bawi",
      "250202": "Mitchell Douglass",
      "250298": "Heyden Halstead",
      "270391": "Nate Jones",
      "280335": "Calli Justice",
      "260913": "Levi Kane",
      "280508": "Colden Oakley",
      "250606": "Madeline Penney",
      "250639": "Rohan Rajanahalli",
      "260627": "Mason Robbins"
    };
    
    const snacks = [
      { id: "A1", name: "Chips", quantity: 8, image: "placeholder.svg" },
      { id: "A2", name: "Cookies", quantity: 5, image: "placeholder.svg" },
      { id: "A3", name: "Pretzels", quantity: 12, image: "placeholder.svg" },
      { id: "B1", name: "Candy Bar", quantity: 7, image: "placeholder.svg" },
      { id: "B2", name: "Granola Bar", quantity: 3, image: "placeholder.svg" },
      { id: "B3", name: "Trail Mix", quantity: 9, image: "placeholder.svg" }
    ];
    
    // ----- Idle Timer Handling (90 seconds) -----
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        signOut();
      }, 90 * 1000); // 90 seconds
    }
    // Reset idle timer on key, click, mouse move, or touch
    document.addEventListener("keydown", resetIdleTimer);
    document.addEventListener("click", resetIdleTimer);
    document.addEventListener("mousemove", resetIdleTimer);
    document.addEventListener("touchstart", resetIdleTimer);
    resetIdleTimer(); // Initialize on load

    // ----- Utility Function -----
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId.split("-")[0]; // e.g., "logo-screen" -> "logo"
    }

    // ----- Dev Button (Invisible) -----
    const devButton = document.getElementById("devButton");
    devButton.addEventListener("click", () => {
      // Bypass login, sign in as DEV MODE
      studentId = "DEV MODE";
      document.getElementById("student-name").textContent = "DEV MODE";
      showScreen("snack-screen");
      initSnackScreen();
    });
    
    // ----- Logo Screen (Tap Anywhere) -----
    const logoScreen = document.getElementById("logo-screen");
    logoScreen.addEventListener("click", () => {
      // Move to Keypad Screen
      showScreen("keypad-screen");
      initKeypad();
    });
    // Also any key press on the logo screen to go to keypad
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "logo") {
        showScreen("keypad-screen");
        initKeypad();
      }
    });
    
    // ----- Keypad Screen -----
    const digitDisplay = document.getElementById("digit-display");
    const keypadButtons = document.getElementById("keypad-buttons");
    const maxDigits = 6;

    // Define our keypad layout in a 3x4 grid
    const keypadLayout = [
      "1","2","3",
      "4","5","6",
      "7","8","9",
      "", "0", "backspace"
    ];

    function initKeypad() {
      studentId = "";
      renderDigits();

      // Build keypad if empty
      if (keypadButtons.children.length === 0) {
        keypadLayout.forEach(value => {
          if (value === "") {
            // Empty spot, create an invisible placeholder for spacing
            const placeholder = document.createElement("div");
            placeholder.style.width = "80px";
            placeholder.style.height = "80px";
            keypadButtons.appendChild(placeholder);
          }
          else {
            const btn = document.createElement("div");
            btn.classList.add("keypad-btn");

            if (value === "backspace") {
              btn.classList.add("backspace");
              btn.textContent = "←";
              btn.addEventListener("click", handleBackspace);
            } else {
              btn.textContent = value;
              btn.addEventListener("click", () => handleDigitInput(value));
            }
            keypadButtons.appendChild(btn);
          }
        });
      }
    }
    
    function renderDigits() {
      digitDisplay.innerHTML = "";
      for (let i = 0; i < maxDigits; i++) {
        const box = document.createElement("div");
        box.classList.add("digit-box");
        box.textContent = i < studentId.length ? "•" : "_";
        digitDisplay.appendChild(box);
      }
    }
    
    function handleDigitInput(digit) {
      if (studentId.length < maxDigits) {
        studentId += digit;
        renderDigits();
        if (studentId.length === maxDigits) {
          validateStudentId();
        }
      }
    }
    
    function handleBackspace() {
      if (studentId.length > 0) {
        studentId = studentId.slice(0, -1);
        renderDigits();
      }
    }
    
    // Keydown events on Keypad Screen
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "keypad") {
        if (/^\d$/.test(e.key)) {
          handleDigitInput(e.key);
        } else if (e.key === "Backspace") {
          handleBackspace();
        } else if (e.key === "Enter" && studentId.length === maxDigits) {
          validateStudentId();
        }
      }
    });
    
    function validateStudentId() {
      if (STUDENTS[studentId]) {
        document.getElementById("student-name").textContent = STUDENTS[studentId];
        showScreen("snack-screen");
        initSnackScreen();
      } else {
        // Shake digit display and reset
        digitDisplay.classList.add("shake");
        setTimeout(() => {
          digitDisplay.classList.remove("shake");
          studentId = "";
          renderDigits();
        }, 500);
      }
    }
    
    // ----- Snack Screen -----
    const snackGrid = document.getElementById("snack-grid");
    const dispenseButton = document.getElementById("dispense-button");
    const snackSignOut = document.getElementById("snack-signout");
    
    function initSnackScreen() {
      selectedItems.clear();
      renderSnackGrid();
      dispenseButton.style.display = "none";
    }
    
    function renderSnackGrid() {
      snackGrid.innerHTML = "";
      snacks.forEach(snack => {
        const snackDiv = document.createElement("div");
        snackDiv.classList.add("snack-item");
        snackDiv.innerHTML = `
          <img src="${snack.image}" alt="${snack.name}">
          <h4>${snack.name}</h4>
          <p>ID: ${snack.id} | Qty: ${snack.quantity}</p>
        `;
        snackDiv.addEventListener("click", () => toggleSnackSelection(snack.id, snackDiv));
        snackGrid.appendChild(snackDiv);
      });
    }
    
    function toggleSnackSelection(snackId, element) {
      if (selectedItems.has(snackId)) {
        selectedItems.delete(snackId);
        element.classList.remove("selected");
      } else {
        selectedItems.add(snackId);
        element.classList.add("selected");
      }
      if (selectedItems.size > 0) {
        dispenseButton.style.display = "block";
        dispenseButton.textContent = selectedItems.size === 1 ? "Dispense Snack" : "Dispense Snacks";
      } else {
        dispenseButton.style.display = "none";
      }
    }
    
    // Snack Screen key events
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "snack") {
        if (["1","2","3","4","5","6"].includes(e.key)) {
          const index = parseInt(e.key, 10) - 1;
          if (index < snacks.length) {
            const snackId = snacks[index].id;
            const snackDiv = snackGrid.children[index];
            toggleSnackSelection(snackId, snackDiv);
          }
        } else if (e.key === "Enter" && selectedItems.size > 0) {
          proceedToDispense();
        } else if (e.key === "Escape") {
          signOut();
        }
      }
    });
    
    dispenseButton.addEventListener("click", proceedToDispense);
    snackSignOut.addEventListener("click", signOut);
    
    function proceedToDispense() {
      showScreen("dispense-screen");
      initDispenseScreen();
    }
    
    // Sign out resets to the logo screen
    function signOut() {
      clearInterval(countdownTimer);
      countdownValue = 5;
      showScreen("logo-screen");
    }
    
    // ----- Dispense Screen -----
    const thankYouMsg = document.getElementById("thank-you-msg");
    const countdownEl = document.getElementById("countdown");
    const staySignedBtn = document.getElementById("stay-signed-btn");
    
    function initDispenseScreen() {
      const name = STUDENTS[studentId] || "Student";
      const firstName = name.split(" ")[0];
      thankYouMsg.textContent = `Thank you, ${firstName}!`;
      countdownValue = 5;
      countdownEl.textContent = countdownValue;
      startCountdown();
    }
    
    function startCountdown() {
      countdownTimer = setInterval(() => {
        countdownValue--;
        countdownEl.textContent = countdownValue;
        if (countdownValue <= 0) {
          clearInterval(countdownTimer);
          signOut();
        }
      }, 1000);
    }
    
    staySignedBtn.addEventListener("click", () => {
      clearInterval(countdownTimer);
      // On stay signed in, clear previously selected items so user can pick again
      showScreen("snack-screen");
      initSnackScreen();
    });
    
    // Keydown events for Dispense Screen
    window.addEventListener("keydown", (e) => {
      if (currentScreen === "dispense") {
        if (e.key === "Enter") {
          clearInterval(countdownTimer);
          showScreen("snack-screen");
          initSnackScreen(); // Clear previous selection
        } else if (e.key === "Escape") {
          clearInterval(countdownTimer);
          signOut();
        } else {
          // Any other key stops countdown
          clearInterval(countdownTimer);
        }
      }
    });
  </script>
</body>
</html>
