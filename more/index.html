<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body {
      width:100%; height:100vh;
      overflow:hidden; overscroll-behavior:none;
      touch-action:none;
      font-family:Arial,sans-serif;
      background:#fff;
    }
    /* cursor only on fine pointers (e.g. mouse) */
    @media (pointer: fine) {
      html,body,button,a { cursor:auto!important; }
    }
    @media (pointer: coarse) {
      html,body,button,a { cursor:none!important; }
    }
    button { transition:transform .1s; user-select:none; }
    button:active { transform:scale(.95); }

    /* APP & VERSION */
    #app { position:relative; width:100%; height:100%; }
    #version-label {
      position:fixed; bottom:10px; left:10px;
      color:#555; font-size:0.9em; z-index:9999;
    }
    #devButton {
      position:fixed; top:0; right:0;
      width:50px; height:50px;
      background:transparent; border:none; opacity:0;
      z-index:10002; pointer-events:auto;
    }

    /* TOP BAR (Menu + Sign Out) */
    #topBar {
      position:absolute; top:10px; right:20px;
      display:flex; gap:12px; z-index:100;
    }
    #menuBtn {
      background:#34495e; color:#fff;
      padding:12px 20px; font-size:1em;
      border:none; border-radius:6px;
      touch-action:manipulation;
      display:none; /* only in dev */
    }
    #snack-signout {
      background:#e74c3c; color:#fff;
      padding:12px 24px; font-size:1em;
      border:none; border-radius:6px;
      touch-action:manipulation;
    }

    /* SCREENS */
    .screen {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:90%; max-width:800px;
      text-align:center; display:none;
    }
    .screen.active { display:block; }

    /* LOGO */
    #logo-screen img {
      width:300px; height:300px; border-radius:50%;
      box-shadow:0 0 20px rgba(0,0,0,.5);
      animation:pulse 2s infinite alternate;
    }
    @keyframes pulse { from{transform:scale(1)} to{transform:scale(1.05)} }
    #logo-screen h2 {
      margin-top:20px; font-size:2.5em; color:#333;
      cursor:pointer;
    }

    /* KEYPAD */
    #keypad-screen h2 { margin-bottom:20px; font-size:2.2em; color:#333; }
    #digit-display { display:flex; justify-content:center; margin-bottom:20px; }
    .digit-box {
      width:70px;height:70px;margin:0 5px;
      border-bottom:2px solid #333;
      font-size:3em; line-height:70px;
    }
    .keypad-grid {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:10px; justify-items:center;
    }
    .keypad-btn {
      width:100px;height:100px;border-radius:50%;
      background:rgba(0,0,0,.1);color:#333;
      font-size:2.5em;display:flex;
      align-items:center;justify-content:center;
      touch-action:manipulation;
    }
    .keypad-btn.backspace { background:red;color:#fff; }
    .shake { animation:shake .5s; }
    @keyframes shake {
      0%,100%{transform:translateX(0)}
      20%,60%{transform:translateX(-10px)}
      40%,80%{transform:translateX(10px)}
    }

    /* SNACK SCREEN */
    #snack-screen { padding-top:60px; }
    #student-name {
      position:absolute; top:10px; left:20px;
      font-size:2em; color:#333;
    }
    #snack-screen h2 {
      font-size:2.5em; margin-bottom:30px; color:#333;
    }
    #snack-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:15px; margin-bottom:120px; justify-items:center;
    }
    .snack-item {
      background:rgba(0,0,0,.05);border:2px solid transparent;
      padding:15px;border-radius:8px;text-align:center;
      transition:background .3s,border-color .3s;
      touch-action:manipulation;
    }
    .snack-item.selected {
      background:rgba(52,152,219,.4);border-color:#3498db;
    }
    .snack-item.disabled {
      opacity:.5; cursor:not-allowed;
    }
    .snack-item h4 { margin-bottom:5px;font-size:1.6em; }
    .snack-item p  { font-size:1.2em; }
    #dispense-button {
      position:absolute; bottom:20px; left:50%;
      transform:translateX(-50%);
      padding:25px 35px;font-size:1.8em;
      background:#2ecc71;border:none;border-radius:8px;
      color:#fff; display:none; touch-action:manipulation;
    }

    /* DISPENSE SCREEN */
    #dispense-screen {
      background:#2e3192;color:#fff;
      width:90%;max-width:600px;
      padding:40px;border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    #dispense-screen img { width:100px;height:100px;margin-bottom:20px; }
    #dispense-screen h2 { font-size:2.8em;margin-bottom:10px; }
    #dispense-text { font-size:1.2em;margin-bottom:10px; }
    #dispense-screen p { font-size:1.4em;margin-bottom:20px; }
    #stay-signed-btn {
      background:#2980b9;color:#fff;
      padding:12px 24px;font-size:1.2em;
      border:none;border-radius:8px;
      touch-action:manipulation;
    }

    /* MODALS */
    .modal {
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:320px; max-width:90%;
      max-height:80vh; overflow-y:auto;
      background:#fafafa;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:0;
      display:none; z-index:10001;
    }
    .modal.active { display:block; }
    .modal-header {
      background:#34495e;color:#fff;
      padding:12px 16px;font-size:1.3em;
      border-top-left-radius:12px;
      border-top-right-radius:12px;
    }
    .modal-body { padding:16px; }
    .modal-footer {
      padding:12px 16px;
      text-align:right;
      border-top:1px solid #ddd;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
    }
    .modal-footer button {
      margin-left:8px;
      padding:8px 16px;
      font-size:1em;
      background:#3498db;
      color:#fff;
      border:none;border-radius:6px;
      touch-action:manipulation;
    }
    .modal-footer button:hover { background:#2980b9; }

    /* STOCK GRID */
    #stockModal {
      left:45% !important;
    }
    #stockModal .stock-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
      gap:12px;
    }
    .stock-card {
      background:#ececec;border-radius:8px;
      padding:12px;text-align:center;
      cursor:pointer; transition:background .2s;
    }
    .stock-card:hover { background:#e0e0e0; }
    .stock-card.disabled { opacity:0.5; }

    /* EDIT PANEL */
    #stockEditModal {
      top:50%; left: calc(45% + 180px) !important;
      transform:translateY(-50%);
      width:280px; max-width:85%;
      background:#fafafa;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:0; display:none; z-index:10002;
    }
    #stockEditModal.active { display:block; }
    #stockEditModal .modal-header {
      background:#2c3e50;color:#fff;
      padding:12px 16px;font-size:1.2em;
      border-top-left-radius:12px;
      border-top-right-radius:12px;
    }
    #stockEditModal .modal-body {
      padding:16px;
    }
    #stockEditModal label {
      display:block;margin-top:8px;font-size:0.9em;
    }
    #stockEditModal input[type="text"],
    #stockEditModal input[type="number"] {
      width:100%; padding:6px; font-size:1em;
      margin-top:4px; box-sizing:border-box;
    }
    #stockEditModal input[type="checkbox"] { margin-right:6px; }
    #stockEditModal .actions {
      padding:12px 16px;
      text-align:right;
      border-top:1px solid #ddd;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
    }
    #stockEditModal .actions button {
      margin-left:8px; padding:8px 14px; font-size:0.9em;
      background:#27ae60; color:#fff; border:none; border-radius:6px;
    }
    #stockEditModal .actions button.cancel {
      background:#c0392b;
    }

    /* TOAST */
    #toast-container {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%); z-index:10003;
    }
    .toast {
      background:rgba(0,0,0,.8); color:#fff;
      padding:10px 20px; margin-top:10px;
      border-radius:4px; opacity:0;
      animation:fadein .3s forwards,
               fadeout .3s forwards 2.7s;
    }
    @keyframes fadein { to{opacity:1} }
    @keyframes fadeout{ to{opacity:0} }

    /* MOBILE TWEAKS */
    @media(max-width:600px){
      #logo-screen img{width:250px;height:250px;}
      #logo-screen h2{font-size:2.2em;}
      .digit-box{width:80px;height:80px;font-size:3.5em;line-height:80px;}
      .keypad-btn{width:90px;height:90px;font-size:2.2em;}
      #student-name{font-size:1.8em;}
      #menuBtn,#snack-signout{font-size:1em;padding:10px 16px;}
      #snack-screen h2{font-size:2.2em;}
      .snack-item h4{font-size:1.8em;}
      #dispense-button{font-size:2em;padding:30px 40px;}
      #dispense-screen{padding:30px;border-radius:12px;}
      #dispense-screen h2{font-size:2.4em;}
      #dispense-text{font-size:1.1em;}
      #dispense-screen p{font-size:1.2em;}
      #stay-signed-btn{font-size:1.4em;padding:10px 20px;}
      .modal{width:90%;max-width:360px;}
      /* Keep edit panel hidden on small */
      #stockEditModal{display:none;}
    }
  </style>
</head>

<body>
  <div id="app">
    <button id="devButton"></button>

    <!-- Logo Screen -->
    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo"/>
      <h2>Tap to Begin</h2>
    </div>

    <!-- Keypad Screen -->
    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons"></div>
    </div>

    <!-- Snack Screen -->
    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <div id="topBar">
        <button id="menuBtn">Menu</button>
        <button id="snack-signout">Sign Out</button>
      </div>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>

    <!-- Dispense Confirmation -->
    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo"/>
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-text">Your snack(s) will be dispensed shortly</div>
      <p>Signing you out in <span id="countdown">5</span></p>
      <button id="stay-signed-btn">Stay Signed In</button>
    </div>

    <!-- Dev Menu Modal -->
    <div id="menuModal" class="modal">
      <div class="modal-header">Dev Menu</div>
      <div class="modal-body">
        <button id="openConfigBtn">Set Local Key</button>
        <button id="openStockBtn">Stock Management</button>
      </div>
      <div class="modal-footer">
        <button id="menuClose">Close</button>
      </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal">
      <div class="modal-header">Set Local Secret Key</div>
      <div class="modal-body">
        <input id="configInput" placeholder="Enter new key" />
      </div>
      <div class="modal-footer">
        <button id="configClose">Cancel</button>
        <button id="configSave">Save</button>
      </div>
    </div>

    <!-- Stock Management Modal -->
    <div id="stockModal" class="modal">
      <div class="modal-header">Stock Management</div>
      <div class="modal-body">
        <div class="stock-grid" id="stock-grid"></div>
      </div>
      <div class="modal-footer">
        <button id="stockClose">Close</button>
      </div>
    </div>

    <!-- Stock Edit Panel -->
    <div id="stockEditModal">
      <div class="modal-header">Edit Item</div>
      <div class="modal-body">
        <label>Name:</label>
        <input type="text" id="editName"/>
        <label>Stock:</label>
        <input type="number" id="editQty" min="0"/>
        <label><input type="checkbox" id="editEnabled"/>Enabled</label>
      </div>
      <div class="actions">
        <button class="cancel" id="editCancel">Cancel</button>
        <button id="editSave">Save</button>
      </div>
    </div>

    <div id="toast-container"></div>
    <div id="version-label"></div>
  </div>

  <script>
    // Prevent all native touch scrolling
    document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

    // App version
    const APP_VERSION = "v2.7.4";

    // Firebase initialization
    const cfg = {
      apiKey: "AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
      authDomain: "cyberflashvend.firebaseapp.com",
      databaseURL: "https://cyberflashvend-default-rtdb.firebaseio.com/",
      projectId: "cyberflashvend",
      storageBucket: "cyberflashvend.firebasestorage.app",
      messagingSenderId: "63786658773",
      appId: "1:63786658773:web:7792d3693ef45e9ec4eb5c"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // Globals
    let serverSecret = null,
        machineConfig = {},
        currentScreen = "logo",
        studentId = "",
        selectedItems = new Set(),
        idleTimer, countdownTimer, countdownValue = 5;

    const STUDENTS = {
      "260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi",
      "250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones",
      "280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley",
      "250606":"Madeline Penney","250639":"Rohan Rajanahalli","260627":"Mason Robbins"
    };
    const SNACK_SLOTS = [
      {slot:"A1",name:"Chips",     quantity:8},
      {slot:"A2",name:"Cookies",   quantity:5},
      {slot:"A3",name:"Pretzels",  quantity:12},
      {slot:"B1",name:"Candy Bar", quantity:7},
      {slot:"B2",name:"Granola Bar",quantity:3},
      {slot:"B3",name:"Trail Mix", quantity:9}
    ];

    // Load config & machineManagement then init
    async function loadServer(){
      serverSecret = (await db.ref("Config").once("value")).val();
      machineConfig = (await db.ref("machineManagement").once("value")).val() || {};
      initApp();
    }
    loadServer();

    // Idle logout
    function resetIdle(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(signOut,90*1000);
    }
    ["keydown","click","mousemove","touchstart"]
      .forEach(evt => document.addEventListener(evt,resetIdle));
    resetIdle();

    // Show screen helper
    function showScreen(id){
      document.querySelectorAll(".screen")
              .forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentScreen = id.split("-")[0];
    }

    // Init entire app
    function initApp(){
      document.getElementById("version-label").textContent = APP_VERSION;
      setupDev(); setupLogo(); setupKeypad();
      setupSnack(); setupDispense(); setupMenu(); setupModals();
    }

    // Toast
    function showToast(msg){
      const t = document.createElement("div");
      t.className="toast"; t.textContent=msg;
      document.getElementById("toast-container").appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    /* DEV MODE OFFLINE */
    function setupDev(){
      const devBtn = document.getElementById("devButton");
      window.addEventListener("keydown", e=>{
        if(e.key.toLowerCase()==="d") activateDev();
      });
      ["click","touchstart"].forEach(evt=>{
        devBtn.addEventListener(evt, e=>{
          if(evt==="touchstart") e.preventDefault();
          activateDev();
        },{passive:false});
      });
    }
    function activateDev(){
      studentId="DEV MODE";
      document.getElementById("student-name").textContent="DEV MODE";
      showScreen("snack-screen");
      renderSnackGrid();
      document.getElementById("menuBtn").style.display="block";
    }

    /* LOGO SCREEN */
    function setupLogo(){
      const img = document.querySelector("#logo-screen img"),
            txt = document.querySelector("#logo-screen h2");
      ["click","touchstart"].forEach(evt=>{
        img.addEventListener(evt, e=>{
          if(evt==="touchstart") e.preventDefault();
          showScreen("keypad-screen"); initKeypad();
        },{passive:false});
        txt.addEventListener(evt, e=>{
          if(evt==="touchstart") e.preventDefault();
          showScreen("keypad-screen"); initKeypad();
        },{passive:false});
      });
      window.addEventListener("keydown", e=>{
        if(currentScreen==="logo") showScreen("keypad-screen"), initKeypad();
      });
    }

    /* KEYPAD LOGIC */
    const digitDisplay = document.getElementById("digit-display"),
          keypadButtons = document.getElementById("keypad-buttons"),
          maxDigits = 6;
    const layout = ["1","2","3","4","5","6","7","8","9","","0","backspace"];
    function isNumKey(e){
      return /^\d$/.test(e.key)||(e.code.startsWith("Numpad")&&e.key.length===1);
    }
    function setupKeypad(){
      initKeypad();
      window.addEventListener("keydown", e=>{
        if(currentScreen==="keypad"&&!e.repeat){
          if(isNumKey(e)){ e.preventDefault(); handleDigit(e.key.slice(-1)); }
          else if(e.key==="Backspace"){ e.preventDefault(); handleBack(); }
          else if((e.key==="Enter"||e.code==="NumpadEnter") && studentId.length===maxDigits){
            e.preventDefault(); validateID();
          }
        }
      });
    }
    function initKeypad(){
      studentId=""; renderDigits();
      if(!keypadButtons.childElementCount){
        layout.forEach(val=>{
          if(!val){
            const ph=document.createElement("div");
            ph.style.width="100px"; ph.style.height="100px";
            keypadButtons.appendChild(ph);
          } else {
            const btn=document.createElement("div");
            btn.className="keypad-btn"+(val==="backspace"?" backspace":"");
            btn.textContent = val==="backspace"?"←":val;
            if(val==="backspace"){
              btn.addEventListener("touchstart",e=>{e.preventDefault();handleBack()},{passive:false});
              btn.addEventListener("click",handleBack);
            } else {
              btn.addEventListener("touchstart",e=>{e.preventDefault();handleDigit(val)},{passive:false});
              btn.addEventListener("click",()=>handleDigit(val));
            }
            keypadButtons.appendChild(btn);
          }
        });
      }
    }
    function renderDigits(){
      digitDisplay.innerHTML="";
      for(let i=0;i<maxDigits;i++){
        const d=document.createElement("div");
        d.className="digit-box";
        d.textContent=i<studentId.length?"•":"_";
        digitDisplay.appendChild(d);
      }
    }
    function handleDigit(ch){
      if(studentId.length<maxDigits){
        studentId+=ch; renderDigits();
        if(studentId.length===maxDigits) validateID();
      }
    }
    function handleBack(){
      if(studentId.length){
        studentId=studentId.slice(0,-1);
        renderDigits();
      }
    }
    function validateID(){
      if(STUDENTS[studentId]){
        document.getElementById("student-name").textContent=STUDENTS[studentId];
        showScreen("snack-screen"); renderSnackGrid();
      } else {
        digitDisplay.classList.add("shake");
        setTimeout(()=>{
          digitDisplay.classList.remove("shake");
          studentId=""; renderDigits();
        },500);
        showToast("Invalid ID");
      }
    }

    /* SNACK SCREEN */
    const snackGrid    = document.getElementById("snack-grid"),
          signOutBtn   = document.getElementById("snack-signout");
    function setupSnack(){
      ["click","touchstart"].forEach(evt=>{
        signOutBtn.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          signOut();
        },{passive:false});
      });
      window.addEventListener("keydown", e=>{
        if(currentScreen==="snack"&&!e.repeat){
          if(isNumKey(e)){
            const idx=+e.key-1;
            if(idx>=0&&idx<SNACK_SLOTS.length)
              toggleSnack(SNACK_SLOTS[idx].slot,snackGrid.children[idx]);
          } else if((e.key==="Enter"||e.code==="NumpadEnter")&&selectedItems.size){
            proceedToDispense();
          } else if(e.key==="Escape"){
            signOut();
          }
        }
      });
    }
    function renderSnackGrid(){
      selectedItems.clear();
      snackGrid.innerHTML="";
      SNACK_SLOTS.forEach(s=>{
        const cfgItem = machineConfig[s.slot]||{},
              enabled = cfgItem.enabled!==false,
              stock   = cfgItem.stock!=null?cfgItem.stock:s.quantity,
              name    = cfgItem.name||s.name;
        const card = document.createElement("div");
        card.className = "snack-item" + (enabled?"":" disabled");
        card.innerHTML = `<h4>${name}</h4><p>ID: ${s.slot} | Qty: ${stock}</p>`;
        if(enabled){
          ["click","touchstart"].forEach(evt=>{
            card.addEventListener(evt,e=>{
              if(evt==="touchstart") e.preventDefault();
              toggleSnack(s.slot,card);
            },{passive:false});
          });
        }
        snackGrid.appendChild(card);
      });
      document.getElementById("menuBtn").style.display =
        (studentId==="DEV MODE"?"block":"none");
    }
    function toggleSnack(slot,el){
      if(el.classList.contains("disabled")) return;
      if(selectedItems.has(slot)){
        selectedItems.delete(slot); el.classList.remove("selected");
      } else {
        selectedItems.add(slot); el.classList.add("selected");
      }
      const disp = document.getElementById("dispense-button");
      if(selectedItems.size){
        disp.style.display="block";
        disp.textContent = selectedItems.size===1?"Dispense Snack":"Dispense Snacks";
      } else {
        disp.style.display="none";
      }
    }

    /* MENU & STOCK MANAGEMENT */
    function setupMenu(){
      const menuBtn    = document.getElementById("menuBtn"),
            menuModal  = document.getElementById("menuModal"),
            stockBtn   = document.getElementById("openStockBtn"),
            menuClose  = document.getElementById("menuClose");
      ["click","touchstart"].forEach(evt=>{
        menuBtn.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          menuModal.classList.add("active");
        },{passive:false});
        menuClose.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          menuModal.classList.remove("active");
        },{passive:false});
        stockBtn.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          openStockModal();
        },{passive:false});
      });
    }
    function openStockModal(){
      document.getElementById("stockModal").classList.add("active");
      renderStockGrid();
    }
    function renderStockGrid(){
      const grid = document.getElementById("stock-grid");
      grid.innerHTML = "";
      SNACK_SLOTS.forEach(s=>{
        const cfgItem = machineConfig[s.slot]||{},
              stock   = cfgItem.stock!=null?cfgItem.stock:s.quantity,
              enabled = cfgItem.enabled!==false;
        const card = document.createElement("div");
        card.className = "stock-card" + (enabled?"":" disabled");
        card.innerHTML = `<strong>${s.slot}</strong><br>${cfgItem.name||s.name}<br>Qty: ${stock}`;
        card.addEventListener("click",()=>openEditPanel(s.slot));
        grid.appendChild(card);
      });
      document.getElementById("stockClose").onclick = () => {
        document.getElementById("stockModal").classList.remove("active");
        document.getElementById("stockEditModal").classList.remove("active");
      };
    }

    /* EDIT PANEL */
    function openEditPanel(slot){
      const cfgItem = machineConfig[slot]||{},
            base    = SNACK_SLOTS.find(x=>x.slot===slot);
      document.querySelector("#stockEditModal .modal-header").textContent = `Edit ${slot}`;
      document.getElementById("editName").value    = cfgItem.name||base.name;
      document.getElementById("editQty").value     = cfgItem.stock!=null?cfgItem.stock:base.quantity;
      document.getElementById("editEnabled").checked = cfgItem.enabled!==false;
      document.getElementById("stockEditModal").classList.add("active");

      document.getElementById("editCancel").onclick = () => {
        document.getElementById("stockEditModal").classList.remove("active");
      };
      document.getElementById("editSave").onclick = async () => {
        machineConfig[slot] = {
          name: document.getElementById("editName").value,
          stock: parseInt(document.getElementById("editQty").value),
          enabled: document.getElementById("editEnabled").checked
        };
        try {
          await db.ref(`machineManagement/${slot}`).set(machineConfig[slot]);
          showToast("Saved");
          document.getElementById("stockEditModal").classList.remove("active");
          renderStockGrid();
          renderSnackGrid();
        } catch(e){
          console.error(e);
          showToast("Save failed");
        }
      };
    }

    /* CONFIG MODAL */
    function setupModals(){
      const cfgModal  = document.getElementById("configModal"),
            cfgInput  = document.getElementById("configInput"),
            cfgSave   = document.getElementById("configSave"),
            cfgClose  = document.getElementById("configClose"),
            openCfg   = document.getElementById("openConfigBtn");
      ["click","touchstart"].forEach(evt=>{
        openCfg.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          cfgInput.value = localStorage.getItem("secretKey")||"";
          cfgModal.classList.add("active");
        },{passive:false});
        cfgClose.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          cfgModal.classList.remove("active");
        },{passive:false});
        cfgSave.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          const k = cfgInput.value.trim();
          if(!k){ showToast("Enter key"); return; }
          localStorage.setItem("secretKey",k);
          showToast("Key set");
          cfgModal.classList.remove("active");
        },{passive:false});
      });
      cfgInput.addEventListener("keydown", e=>{
        if(e.key==="Enter") cfgSave.click();
      });
    }

    /* DISPENSE FLOW */
    function proceedToDispense(){
      if(!selectedItems.size) return;
      sendDispenseSignal();
      showScreen("dispense-screen");
      initDispense();
    }
    function signOut(){
      clearInterval(countdownTimer);
      countdownValue=5;
      showScreen("logo-screen");
    }
    async function sendDispenseSignal(){
      const localKey = localStorage.getItem("secretKey");
      if(localKey!==serverSecret){
        showToast("Unauthorized"); return;
      }
      const user = (studentId==="DEV MODE"? "DEV MODE": STUDENTS[studentId]);
      const data = {Status:true, User:user};
      SNACK_SLOTS.forEach((s,i)=> data[`Item${i+1}`] = selectedItems.has(s.slot));
      try{ await db.ref("data").update(data); }catch(e){console.error(e);}
      // Log
      const now=new Date(),
            mm=("0"+(now.getMonth()+1)).slice(-2),
            dd=("0"+now.getDate()).slice(-2),
            yy=(""+now.getFullYear()).slice(-2).slice(-2),
            key=`${mm}-${dd}-${yy}`,
            h=now.getHours(), m=("0"+now.getMinutes()).slice(-2),
            s=("0"+now.getSeconds()).slice(-2),
            ap=h>=12?"pm":"am", hr=h%12||12,
            time=`${hr}h:${m}m:${s}s${ap}`,
            payload=[];
      SNACK_SLOTS.forEach((_,i)=> selectedItems.has(_.slot) && payload.push(i+1));
      const log = {Time:time,User:user,Payload:payload.join(",")};
      try{ await db.ref(`Logs/${key}`).push(log);}catch(e){console.error(e);}
    }

    /* DISPENSE UI */
    function setupDispense(){
      const stay = document.getElementById("stay-signed-btn");
      ["click","touchstart"].forEach(evt=>{
        stay.addEventListener(evt,e=>{
          if(evt==="touchstart") e.preventDefault();
          clearInterval(countdownTimer);
          showScreen("snack-screen");
          renderSnackGrid();
        },{passive:false});
      });
      window.addEventListener("keydown", e=>{
        if(currentScreen==="dispense"){
          if(e.key==="Enter"||e.code==="NumpadEnter"){
            clearInterval(countdownTimer);
            showScreen("snack-screen");
            renderSnackGrid();
          } else if(e.key==="Escape"){
            clearInterval(countdownTimer);
            signOut();
          } else {
            clearInterval(countdownTimer);
          }
        }
      });
    }
    function initDispense(){
      const user = (studentId==="DEV MODE"? "DEV MODE": STUDENTS[studentId]);
      document.getElementById("thank-you-msg").textContent=
        `Thank you, ${user.split(" ")[0]}!`;
      countdownValue=5;
      document.getElementById("countdown").textContent=5;
      countdownTimer=setInterval(()=>{
        countdownValue--;
        document.getElementById("countdown").textContent=countdownValue;
        if(countdownValue<=0){
          clearInterval(countdownTimer);
          signOut();
        }
      },1000);
    }
  </script>
</body>
</html>
