<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body {
      width:100%; height:100vh;
      overflow:hidden; overscroll-behavior:none; touch-action:none;
      font-family:Arial,sans-serif; background:#fff;
    }
    html, body, button, a { cursor:none!important; }
    button { transition:transform .1s; user-select:none; }
    button:active { transform:scale(.95); }

    /* APP & VERSION */
    #app { position:relative; width:100%; height:100%; }
    #version-label { position:fixed; bottom:10px; left:10px; color:#555; z-index:9999; }
    #devButton {
      position:fixed; top:0; right:0; width:50px; height:50px;
      background:transparent; border:none; opacity:0;
      z-index:10002; pointer-events:auto; cursor:pointer;
    }

    /* SCREENS */
    .screen {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:90%; max-width:800px; text-align:center; display:none;
    }
    .screen.active { display:block; }

    /* LOGO */
    #logo-screen img {
      width:300px; height:300px; border-radius:50%;
      box-shadow:0 0 20px rgba(0,0,0,.5);
      animation:pulse 2s infinite alternate; cursor:pointer;
    }
    @keyframes pulse { from{transform:scale(1)} to{transform:scale(1.05)} }
    #logo-screen h2 {
      margin-top:20px; font-size:2.5em; color:#333; cursor:pointer;
    }

    /* KEYPAD */
    #keypad-screen h2 { margin-bottom:20px; font-size:2.2em; color:#333; }
    #digit-display { display:flex; justify-content:center; margin-bottom:20px; }
    .digit-box {
      width:70px; height:70px; margin:0 5px;
      border-bottom:2px solid #333; font-size:3em; line-height:70px;
    }
    .keypad-grid {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:10px; justify-items:center;
    }
    .keypad-btn {
      width:100px; height:100px; border-radius:50%;
      background:rgba(0,0,0,.1); color:#333;
      font-size:2.5em; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; touch-action:manipulation;
    }
    .keypad-btn.backspace { background:red; color:#fff; }
    .shake { animation:shake .5s; }
    @keyframes shake {
      0%{transform:translateX(0)}20%{transform:translateX(-10px)}
      40%{transform:translateX(10px)}60%{transform:translateX(-10px)}
      80%{transform:translateX(10px)}100%{transform:translateX(0)}
    }

    /* SNACK */
    #snack-screen {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:90%; max-width:800px; padding-top:100px;
      text-align:center;
    }
    #student-name {
      position:absolute; top:10px; left:20px;
      font-size:2em; color:#333;
    }
    #snack-signout {
      position:absolute; top:10px; right:20px;
      background:#e74c3c; color:#fff;
      padding:16px 32px; font-size:1.6em;
      border:none; border-radius:6px; cursor:pointer;
      touch-action:manipulation;
    }
    #menuBtn {
      position:absolute; top:10px; right:150px;
      background:#2c3e50; color:#fff;
      padding:16px 32px; font-size:1.6em;
      border:none; border-radius:6px; cursor:pointer;
      touch-action:manipulation;
    }
    #snack-screen h2 {
      font-size:2.5em; margin-bottom:30px; color:#333;
    }
    #snack-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:15px; margin-bottom:120px; justify-items:center;
    }
    .snack-item {
      background:rgba(0,0,0,.05); border:2px solid transparent;
      padding:15px; border-radius:8px; cursor:pointer;
      transition:background .3s,border-color .3s;
      text-align:center; touch-action:manipulation;
      position:relative;
      opacity:1;
    }
    .snack-item.disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    .snack-item h4 { margin-bottom:5px; font-size:1.6em; }
    .snack-item p  { font-size:1.2em; }
    .snack-item .stock-count {
      position:absolute; bottom:8px; right:8px;
      font-size:.9em; color:#555;
    }

    /* DISPENSE */
    #dispense-screen {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:90%; max-width:600px;
      background:#2e3192; border-radius:15px;
      padding:40px; box-shadow:0 10px 30px rgba(0,0,0,.3);
      color:#fff; text-align:center;
    }
    #dispense-screen img { width:100px; height:100px; margin-bottom:20px; }
    #dispense-screen h2 { font-size:2.8em; margin-bottom:10px; font-weight:bold; }
    #dispense-screen #dispense-text { font-size:1.2em; margin-bottom:10px; }
    #dispense-screen p { font-size:1.4em; margin-bottom:20px; }
    #stay-signed-btn {
      background:#2980b9; border:none; padding:12px 24px;
      font-size:1.2em; color:#fff; border-radius:8px; cursor:pointer;
      touch-action:manipulation;
    }

    /* MODALS */
    .modal {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fefefe; border-radius:8px;
      box-shadow:0 5px 15px rgba(0,0,0,.2);
      z-index:10000; width:90%; max-width:400px;
      display:none; padding:20px; text-align:left;
    }
    .modal.active { display:block; }
    .modal-header { margin-bottom:15px; font-size:1.4em; font-weight:bold; }
    .modal-body { margin-bottom:15px; }
    .modal-footer { text-align:right; }
    .modal-footer button {
      margin-left:8px; padding:8px 16px; font-size:1em; cursor:pointer;
      touch-action:manipulation;
    }
    .modal input, .modal select {
      width:100%; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:4px; font-size:1em;
    }

    /* STOCK MGMT: grid layout */
    #stockModal .modal-body {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
      gap:16px;
      max-height:60vh;
      overflow-y:auto;
      padding:8px 0;
    }
    .stock-card {
      border:1px solid #ddd; border-radius:6px; padding:12px;
      background:#fafafa;
    }
    .stock-card h4 { margin-bottom:8px; font-size:1.1em; }
    .stock-card label { font-size:.9em; }
    .stock-card input[type="checkbox"] { transform:scale(1.2); margin-right:6px; }

    /* TOAST */
    #toast-container {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%); z-index:10001;
    }
    .toast {
      display:inline-block; background:rgba(0,0,0,.8);
      color:#fff; padding:10px 20px; margin-top:10px;
      border-radius:4px; opacity:0;
      animation:fadein .3s forwards, fadeout .3s forwards 2.7s;
    }
    @keyframes fadein { to{opacity:1} }
    @keyframes fadeout { to{opacity:0} }

    /* MOBILE */
    @media(max-width:600px){
      #snack-signout,#menuBtn{ padding:12px 24px; font-size:1.4em; }
      .snack-item{ min-width:140px; }
      #stockModal .modal-body{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- hidden but clickable -->
    <button id="devButton"></button>

    <!-- LOGO screen -->
    <div id="logo-screen" class="screen active">
      <img src="fchs-logo.png" alt="Logo" />
      <h2>Tap to Begin</h2>
    </div>

    <!-- KEYPAD screen -->
    <div id="keypad-screen" class="screen">
      <h2>Enter Student ID</h2>
      <div id="digit-display"></div>
      <div class="keypad-grid" id="keypad-buttons"></div>
    </div>

    <!-- SNACK screen -->
    <div id="snack-screen" class="screen">
      <div id="student-name">Student Name</div>
      <button id="menuBtn">Menu</button>
      <button id="snack-signout">Sign Out</button>
      <h2>Select a Snack</h2>
      <div id="snack-grid"></div>
      <button id="dispense-button">Dispense Snacks</button>
    </div>

    <!-- DISPENSE screen -->
    <div id="dispense-screen" class="screen">
      <img src="fchs-logo.png" alt="Logo" />
      <h2 id="thank-you-msg">Thank you, Student!</h2>
      <div id="dispense-text">Your snack(s) will be dispensed shortly</div>
      <p>Signing you out in <span id="countdown">5</span></p>
      <button id="stay-signed-btn">Stay Signed In</button>
    </div>

    <!-- CONFIG modal -->
    <div id="configModal" class="modal">
      <div class="modal-header">Set Local Secret Key</div>
      <div class="modal-body">
        <input id="configInput" placeholder="New local key" />
      </div>
      <div class="modal-footer">
        <button id="configClose">Close</button>
        <button id="configSave">Save</button>
      </div>
    </div>

    <!-- STOCK MANAGEMENT modal -->
    <div id="stockModal" class="modal">
      <div class="modal-header">Stock Management</div>
      <div class="modal-body">
        <!-- cards injected here -->
      </div>
      <div class="modal-footer">
        <button id="stockClose">Close</button>
      </div>
    </div>

    <!-- MENU modal -->
    <div id="menuModal" class="modal">
      <div class="modal-header">Menu</div>
      <div class="modal-body">
        <button id="openConfigBtn">Set Local Key</button>
        <button id="openStockBtn">Manage Stock</button>
      </div>
      <div class="modal-footer">
        <button id="menuClose">Close</button>
      </div>
    </div>

    <div id="toast-container"></div>
    <div id="version-label"></div>
  </div>

  <script>
    // prevent any touch scrolling
    document.addEventListener('touchmove', e => e.preventDefault(), { passive:false });

    // APP VERSION
    const APP_VERSION = "v2.7.2";

    // Firebase init
    const cfg = {
      apiKey: "...", authDomain: "...",
      databaseURL: "...",
      projectId: "...", storageBucket: "...",
      messagingSenderId: "...", appId: "..."
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // server‐side secretKey
    let serverSecret = null;
    async function loadServerKey(){
      serverSecret = (await db.ref("Config").once("value")).val();
      initApp();
    }
    loadServerKey();

    // machineManagement cache
    let management = {};

    // load machine management & snacks data
    async function loadMachineManagement(){
      const snap = await db.ref("machineManagement").once("value");
      management = snap.val()||{};
      renderStockCards();
      renderSnacks();
    }

    // Globals
    let currentScreen="logo", studentId="", selectedItems=new Set();
    let idleTimer, countdownTimer, countdownValue=5;

    const STUDENTS = { /* ... same as before ... */ };
    // default snack layout (order corresponds to A1,A2,A3,B1,B2,B3)
    const defaultSnacks = [
      { slot:"A1", name:"Chips" },
      { slot:"A2", name:"Cookies" },
      { slot:"A3", name:"Pretzels" },
      { slot:"B1", name:"Candy Bar" },
      { slot:"B2", name:"Granola Bar" },
      { slot:"B3", name:"Trail Mix" },
    ];

    // IDLE logout
    function resetIdle(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(signOut, 90*1000);
    }
    ["keydown","click","mousemove","touchstart"].forEach(evt=>document.addEventListener(evt, resetIdle));
    resetIdle();

    // Show screen helper
    function showScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentScreen = id.replace("-screen","");
      // dev button only active on logo
      const dbtn = document.getElementById("devButton");
      if(currentScreen!=="logo" || studentId) {
        dbtn.style.pointerEvents="none";
      } else {
        dbtn.style.pointerEvents="auto";
      }
    }

    // INIT APP
    function initApp(){
      document.getElementById("version-label").textContent = APP_VERSION;
      setupDev();
      setupLogo();
      setupKeypad();
      setupSnack();
      setupDispense();
      setupMenus();
      loadMachineManagement();    // load stock + enforce enable/disable
    }

    // TOAST
    function showToast(msg){
      const t=document.createElement("div");
      t.className="toast"; t.textContent=msg;
      document.getElementById("toast-container").appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    // DEV MODE
    function setupDev(){
      const dbtn = document.getElementById("devButton");
      window.addEventListener("keydown",e=>{ if(e.key==="d") activateDev(); });
      dbtn.addEventListener("click",activateDev);
    }
    function activateDev(){
      studentId="DEV MODE";
      document.getElementById("student-name").textContent="DEV MODE";
      showScreen("snack-screen");
    }

    // LOGO
    function setupLogo(){
      ["img","h2"].forEach(sel=>{
        const el = document.querySelector("#logo-screen "+sel);
        el.addEventListener("click", ()=>{ showScreen("keypad-screen"); });
        el.addEventListener("touchstart", e=>{ e.preventDefault(); showScreen("keypad-screen"); },{passive:false});
      });
      window.addEventListener("keydown",e=>{
        if(currentScreen==="logo") showScreen("keypad-screen");
      });
    }

    // KEYPAD
    function setupKeypad(){
      const layout=["1","2","3","4","5","6","7","8","9","","0","backspace"];
      const container = document.getElementById("keypad-buttons");
      document.getElementById("digit-display").innerHTML="";
      for(let i=0;i<6;i++){
        const d=document.createElement("div");
        d.className="digit-box"; d.textContent="_";
        document.getElementById("digit-display").appendChild(d);
      }
      layout.forEach(val=>{
        const cell=document.createElement(val?"div":"div");
        if(!val){
          cell.style.width="100px"; cell.style.height="100px";
        } else {
          cell.className="keypad-btn"+(val==="backspace"?" backspace":"");
          cell.textContent= val==="backspace"?"←":val;
          cell.addEventListener("click", ()=> handleKey(val));
          cell.addEventListener("touchstart", e=>{ e.preventDefault(); handleKey(val); },{passive:false});
        }
        container.appendChild(cell);
      });
      window.addEventListener("keydown",e=>{
        if(currentScreen==="keypad"){
          if(/^\d$/.test(e.key)) { handleKey(e.key); }
          else if(e.key==="Backspace") handleKey("backspace");
          else if(e.key==="Enter" && studentId.length===6) validateID();
        }
      });
    }

    function handleKey(k){
      if(k==="backspace"){
        studentId=studentId.slice(0,-1);
      } else if(studentId.length<6){
        studentId+=k;
      }
      renderDigits();
      if(studentId.length===6) validateID();
    }
    function renderDigits(){
      const boxes = document.querySelectorAll(".digit-box");
      boxes.forEach((b,i)=>b.textContent = i<studentId.length?"•":"_");
    }
    function validateID(){
      if(STUDENTS[studentId]|| studentId==="DEV MODE"){
        const name = STUDENTS[studentId]|| studentId;
        document.getElementById("student-name").textContent=name;
        showScreen("snack-screen");
      } else {
        document.querySelector(".digit-box").classList.add("shake");
        setTimeout(()=>document.querySelector(".digit-box").classList.remove("shake"),500);
        studentId="";
        renderDigits();
        showToast("Invalid ID");
      }
    }

    // SNACK screen
    function setupSnack(){
      document.getElementById("snack-signout").addEventListener("click",signOut);
      document.getElementById("snack-signout").addEventListener("touchstart",e=>{ e.preventDefault(); signOut(); },{passive:false});
      document.getElementById("dispense-button").addEventListener("click",proceedToDispense);
      document.getElementById("dispense-button").addEventListener("touchstart",e=>{ e.preventDefault(); proceedToDispense(); },{passive:false});
    }

    function renderSnacks(){
      const grid=document.getElementById("snack-grid");
      grid.innerHTML="";
      defaultSnacks.forEach((s,i)=>{
        const cfg = management[s.slot]||{ name:s.name, stock:0, enabled:true};
        const card=document.createElement("div");
        card.className="snack-item"+(cfg.enabled?"":" disabled");
        card.innerHTML = `
          <h4>${cfg.name}</h4>
          <p>ID: ${s.slot} | Qty: ${cfg.stock}</p>
          <div class="stock-count">${cfg.enabled?"":"(Disabled)"}</div>
        `;
        if(cfg.enabled){
          card.addEventListener("click",()=>{
            if(selectedItems.has(s.slot)){
              selectedItems.delete(s.slot);
              card.classList.remove("selected");
            } else {
              selectedItems.add(s.slot);
              card.classList.add("selected");
            }
            document.getElementById("dispense-button").style.display= selectedItems.size?"block":"none";
          });
        }
        grid.appendChild(card);
      });
    }

    // DISPENSE
    function proceedToDispense(){
      if(!selectedItems.size) return;
      // ... your existing sendDispenseSignal + countdown ...
      // then after sending, clear selectedItems
      selectedItems.clear();
      document.getElementById("dispense-button").style.display="none";
    }

    // SIGN OUT
    function signOut(){
      clearInterval(countdownTimer);
      studentId="";
      selectedItems.clear();
      showScreen("logo-screen");
    }

    // MENUS & MODALS
    function setupMenus(){
      // MENU button
      const menuBtn = document.getElementById("menuBtn"),
            menuModal = document.getElementById("menuModal"),
            menuClose = document.getElementById("menuClose"),
            configBtn = document.getElementById("openConfigBtn"),
            stockBtn  = document.getElementById("openStockBtn");
      menuBtn.addEventListener("click", ()=>menuModal.classList.add("active"));
      menuBtn.addEventListener("touchstart",e=>{ e.preventDefault(); menuModal.classList.add("active"); },{passive:false});
      menuClose.addEventListener("click", ()=>menuModal.classList.remove("active"));
      menuClose.addEventListener("touchstart",e=>{ e.preventDefault(); menuModal.classList.remove("active"); },{passive:false});

      // CONFIG
      const cfgModal = document.getElementById("configModal"),
            cfgClose = document.getElementById("configClose"),
            cfgSave  = document.getElementById("configSave"),
            cfgInput = document.getElementById("configInput");
      configBtn.addEventListener("click", ()=>{ cfgModal.classList.add("active"); menuModal.classList.remove("active"); });
      cfgClose.addEventListener("click", ()=>cfgModal.classList.remove("active"));
      cfgSave.addEventListener("click", ()=>{
        const k=cfgInput.value.trim();
        if(k){ localStorage.setItem("secretKey",k); showToast("Key saved"); cfgModal.classList.remove("active"); }
        else showToast("Enter a key");
      });

      // STOCK MGMT
      const stockModal = document.getElementById("stockModal"),
            stockClose = document.getElementById("stockClose");
      stockBtn.addEventListener("click", ()=>{
        stockModal.classList.add("active");
        menuModal.classList.remove("active");
        renderStockCards();
      });
      stockClose.addEventListener("click", ()=>stockModal.classList.remove("active"));
    }

    // RENDER + SAVE stock cards
    function renderStockCards(){
      const body = document.querySelector("#stockModal .modal-body");
      body.innerHTML="";
      defaultSnacks.forEach((s,i)=>{
        const cfg = management[s.slot] || { name:s.name, stock:0, enabled:true };
        const card = document.createElement("div");
        card.className="stock-card";
        card.innerHTML=`
          <h4>Slot ${s.slot}</h4>
          <label>Name:<input type="text" class="name" value="${cfg.name}"></label>
          <label>Stock:<input type="number" class="stock" value="${cfg.stock}"></label>
          <label><input type="checkbox" class="enabled" ${cfg.enabled?"checked":""}> Enabled</label>
          <button class="save">Save</button>
        `;
        // save handler
        card.querySelector(".save").addEventListener("click",async()=>{
          const newCfg = {
            name: card.querySelector(".name").value,
            stock:+card.querySelector(".stock").value,
            enabled: card.querySelector(".enabled").checked
          };
          // update RTDB
          await db.ref(`machineManagement/${s.slot}`).set(newCfg);
          management[s.slot]=newCfg;
          showToast(`Saved ${s.slot}`);
          renderSnacks();
        });
        body.appendChild(card);
      });
    }

  </script>
</body>
</html>
