<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine â€” Admin Panel</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* RESET & GLOBALS */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100%; min-height:100vh; padding:20px;
      font-family:Arial, sans-serif; background:#f5f5f5;
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    h1,h2,h3 { color:#333; margin-bottom:8px; }
    .btn {
      display:inline-block; background:#3498db; color:#fff;
      border:none; border-radius:4px; padding:6px 12px;
      font-size:.95em; text-decoration:none; text-align:center;
      margin:4px; cursor:pointer;
    }
    .btn:hover { background:#2980b9; }
    .btn.cancel { background:#bdc3c7; color:#333; }
    .btn.danger { background:#e74c3c; }
    .btn.danger:hover { background:#c0392b; }
    .btn.save { background:#27ae60; }
    .btn.save:hover { background:#229954; }

    #topButtons { margin-bottom:24px; }
    #topButtons .btn { margin-right:16px; }

    #recentContainer, #dateContainer, #userContainer {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:12px; margin-bottom:24px;
    }
    .card {
      background:#fff; border:1px solid #ddd; border-radius:6px;
      padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .card h4 { margin-bottom:6px; font-size:1em; color:#2c3e50; }
    .card p { font-size:.9em; color:#555; line-height:1.4; }

    #browseSection { margin-bottom:32px; }
    #browseSection h2 { margin-bottom:12px; }
    #searchInput {
      width:100%; padding:8px 12px; font-size:1em;
      border:1px solid #ccc; border-radius:4px;
      margin-bottom:16px;
    }

    /* MODAL */
    #modalOverlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.5); display:none;
      align-items:center; justify-content:center;
      padding:12px; z-index:1000;
    }
    #modal {
      background:#fff; border-radius:6px;
      width:100%; max-width:500px; max-height:80vh;
      overflow-y:auto; box-shadow:0 8px 24px rgba(0,0,0,.2);
      position:relative; padding:16px;
    }
    #modal header {
      display:flex; justify-content:space-between;
      align-items:center; margin-bottom:12px;
    }
    #modal header h3 { font-size:1.25em; color:#2c3e50; }
    #modal header button {
      background:#e74c3c; color:#fff;
      border:none; border-radius:4px; padding:4px 8px;
      cursor:pointer;
    }
    .entry { margin-bottom:12px; }
    .entry h4 { margin-bottom:4px; font-size:1em; color:#2c3e50; }
    .entry p  { font-size:.9em; color:#555; }

    /* MINI CONSOLE AT TOP */
    #miniConsole {
      position:fixed; top:0; left:0; width:100%;
      max-height:30vh; background:#111; color:#0f0;
      font-family:monospace; font-size:.85em;
      overflow-y:auto; padding:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.5);
      z-index:1002;
    }
    #miniConsole div { margin-bottom:4px; }

    /* TOAST */
    #toast-container {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%); z-index:1001;
    }
    .toast {
      background:rgba(0,0,0,.8); color:#fff;
      padding:8px 16px; margin-top:6px; border-radius:4px;
      opacity:0; animation:fadein .3s forwards, fadeout .3s forwards 2.7s;
    }
    @keyframes fadein { to { opacity:1 } }
    @keyframes fadeout { to { opacity:0 } }

    /* MOBILE */
    @media(max-width:600px){
      body { padding:12px; }
      #topButtons { font-size:.9em; }
      .card { padding:8px; }
    }
  </style>
</head>
<body>
  <!-- Mini-console up top -->
  <div id="miniConsole"></div>

  <h1>Admin Panel</h1>
  <div id="topButtons">
    <a class="btn" style="background:orange;" href="https://gmolter.github.io/vend/more" target="_blank">Dev Page</a>
    <a class="btn save" href="https://gmolter.github.io/vend/" target="_blank">Stable Page</a>
  </div>

  <h2>Recent 6 Transactions</h2>
  <div id="recentContainer">Loadingâ€¦</div>
  <button id="moreRecent" class="btn cancel" style="display:none;">Moreâ€¦</button>

  <div id="browseSection">
    <h2>Browse</h2>
    <input id="searchInput" placeholder="Search by Date or User" />
  </div>

  <h3>By Date</h3>
  <div id="dateContainer">Loadingâ€¦</div>

  <h3>By User</h3>
  <div id="userContainer">Loadingâ€¦</div>

  <!-- Modal -->
  <div id="modalOverlay">
    <div id="modal">
      <header>
        <h3 id="modalTitle">Loadingâ€¦</h3>
        <button id="modalClose">X</button>
      </header>
      <div id="modalContent"></div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    // redirect console to miniConsole
    (function(){
      const orig = { log:console.log, warn:console.warn, error:console.error };
      const mc = document.getElementById("miniConsole");
      function feed(type,args){
        const d = document.createElement("div");
        d.textContent = `[${type}] ${Array.from(args).join(" ")}`;
        mc.appendChild(d);
        mc.scrollTop = mc.scrollHeight;
      }
      console.log = function(){ feed("LOG", arguments); orig.log.apply(console,arguments); }
      console.warn = function(){ feed("WARN",arguments); orig.warn.apply(console,arguments); }
      console.error = function(){ feed("ERR", arguments); orig.error.apply(console,arguments); }
    })();

    // disable touch scroll
    document.addEventListener('touchmove', e=>e.preventDefault(),{passive:false});

    // Firebase init
    const cfg = {
      apiKey:"AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
      authDomain:"cyberflashvend.firebaseapp.com",
      databaseURL:"https://cyberflashvend-default-rtdb.firebaseio.com/",
      projectId:"cyberflashvend",
      storageBucket:"cyberflashvend.firebasestorage.app",
      messagingSenderId:"63786658773",
      appId:"1:63786658773:web:7792d3693ef45e9ec4eb5c"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // Data holders
    let allLogs = [];

    // Utility
    function showToast(msg){
      const t=document.createElement("div");
      t.className="toast"; t.textContent=msg;
      document.getElementById("toast-container").appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }
    function fmtTime(t){
      return t.replace(/(\d+)h:(\d+)m:\d+s(am|pm)/, (_,h,m,ap)=>`${h}:${m}${ap}`);
    }
    const SNACK_SLOTS = [
      {slot:"C2",name:"Chips"},
      {slot:"E1",name:"Cookies"},
      {slot:"E2",name:"Pretzels"},
      {slot:"E3",name:"Candy Bar"},
      {slot:"E4",name:"Granola Bar"},
      {slot:"E5",name:"Trail Mix"}
    ];
    const STUDENTS = {
      "260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi",
      "250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones",
      "280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley",
      "250606":"Madeline Penney","250639":"Rohan Rajahalli","260627":"Mason Robbins",
      "360794":"Calix Baker","DEV":"DEV MODE"
    };

    // Listen for logs
    console.log("â–¶ï¸ Subscribing to Logsâ€¦");
    db.ref("Logs").on("value", snap=>{
      console.log("ðŸ“¥ Logs snapshot", snap.val());
      const data = snap.val()||{};
      allLogs = [];
      Object.entries(data).forEach(([date, entries])=>{
        Object.values(entries).forEach(l=> allLogs.push({ date, ...l }));
      });
      allLogs.sort((a,b)=>{
        if(a.date!==b.date) return b.date.localeCompare(a.date);
        return a.Time.localeCompare(b.Time);
      });
      showToast(`Loaded ${allLogs.length} entries`);
      renderRecent(); renderByDate(); renderByUser();
    }, err=>{
      console.error("âš ï¸ RTDB error", err);
      showToast("Failed to load logs");
    });

    // DOM shortcuts
    const $ = s=>document.querySelector(s);

    // Recent 6
    function renderRecent(){
      const rc = $("#recentContainer"); rc.innerHTML="";
      const recent = allLogs.slice(0,6);
      recent.forEach(l=>{
        const card = document.createElement("div"); card.className="card";
        card.innerHTML = `
          <h4>${l.date.replace(/-/g,"/")} ${fmtTime(l.Time)}</h4>
          <p><strong>${l.User}</strong><br>
             ${l.Payload.split(",").map(n=>SNACK_SLOTS[n-1]?.name).join(", ")}</p>`;
        rc.appendChild(card);
      });
      $("#moreRecent").style.display = allLogs.length>6?"inline-block":"none";
    }
    $("#moreRecent").onclick = ()=> openLogModal("All Transactions", allLogs);

    // By Date
    function renderByDate(){
      const dc = $("#dateContainer"); dc.innerHTML="";
      const dates = [...new Set(allLogs.map(l=>l.date))];
      if(!dates.length){ dc.textContent="No transactions"; return; }
      dates.forEach(d=>{
        const btn=document.createElement("button");
        btn.className="btn save";
        btn.textContent = d.replace(/-/g,"/");
        btn.onclick = ()=> openLogModal(`Date ${btn.textContent}`,
          allLogs.filter(l=>l.date===d));
        dc.appendChild(btn);
      });
    }

    // By User
    function renderByUser(){
      const uc = $("#userContainer"); uc.innerHTML="";
      Object.entries(STUDENTS).forEach(([id,name])=>{
        const btn=document.createElement("button");
        btn.className="btn";
        btn.textContent = name;
        btn.onclick = ()=> openLogModal(`User ${name}`, allLogs.filter(l=>l.User===name));
        uc.appendChild(btn);
      });
    }

    // Search
    $("#searchInput").addEventListener("keypress", e=>{
      if(e.key==="Enter"){
        const q=e.target.value.trim();
        if(!q) return;
        const dkey=q.replace(/[\/\.]/g,"-");
        const byDate = allLogs.filter(l=>l.date===dkey);
        if(byDate.length) return openLogModal(`Date ${q}`,byDate);
        const byUser = allLogs.filter(l=>l.User.toLowerCase().includes(q.toLowerCase()));
        if(byUser.length) return openLogModal(`User â€œ${q}â€`, byUser);
        showToast("No results");
      }
    });

    // Modal
    $("#modalClose").onclick = () => $("#modalOverlay").style.display="none";
    function openLogModal(title, logs){
      $("#modalTitle").textContent = title;
      const c = $("#modalContent"); c.innerHTML="";
      if(!logs.length){
        c.innerHTML = "<p>No Transactions</p>";
      } else {
        logs.forEach(l=>{
          const div=document.createElement("div"); div.className="entry";
          div.innerHTML=`
            <h4>${l.date.replace(/-/g,"/")} ${fmtTime(l.Time)}</h4>
            <p><strong>${l.User}</strong><br>
               ${l.Payload.split(",").map(n=>SNACK_SLOTS[n-1]?.name).join(", ")}</p>`;
          c.appendChild(div);
        });
      }
      $("#modalOverlay").style.display="flex";
    }
  </script>
</body>
</html>
