<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vending Machine Admin</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* RESET & GLOBAL */
    * { margin:0; padding:0; box-sizing:border-box }
    html, body {
      width:100%; height:100vh;
      overflow:hidden; overscroll-behavior:none;
      touch-action:none; font-family:Arial,sans-serif;
      background:#f5f5f5;
    }
    /* BUTTONS */
    .btn {
      display:inline-block; background:#3498db; color:#fff;
      border:none; border-radius:4px; padding:8px 16px;
      font-size:1em; box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer; text-decoration:none;
    }
    .btn:hover        { background:#2980b9 }
    .btn.save         { background:#27ae60 }
    .btn.save:hover   { background:#229954 }
    .btn.cancel       { background:#bdc3c7; color:#333 }
    .btn.danger       { background:#e74c3c }
    .btn.danger:hover { background:#c0392b }
    .close-btn {
      background:#e74c3c; color:#fff; border:none;
      padding:4px 8px; border-radius:4px; cursor:pointer;
    }
    /* LAYOUT */
    #app {
      position:absolute; top:0; left:0;
      width:100%; height:100vh; overflow-y:auto; padding:16px;
    }
    h1 { font-size:1.8em; margin-bottom:8px; color:#333 }
    .section { margin-bottom:24px }
    .section h2 { font-size:1.4em; margin:12px 0 8px; color:#555 }
    /* CARDS */
    #recentContainer, .card-grid {
      display:grid; gap:12px; margin-bottom:12px;
    }
    #recentContainer { grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
    .card-grid      { grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
    .recent-card, .date-card, .user-card {
      background:#fff; border:1px solid #ddd;
      border-radius:6px; padding:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .recent-card p, .txn-card p {
      margin:4px 0; color:#444; font-size:.95em;
    }
    .recent-card .time { font-weight:bold }
    .date-card, .user-card { text-align:center; cursor:pointer }
    .date-card span, .user-card span {
      display:block; color:#333; font-weight:bold;
    }
    /* SEARCH */
    #searchInput {
      width:100%; padding:8px 12px; font-size:1em;
      border:1px solid #ccc; border-radius:4px;
      margin-bottom:12px;
    }
    /* MODALS */
    .modal-backdrop {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.5); display:none; z-index:1001;
    }
    .modal {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; border-radius:6px;
      width:90%; max-width:500px; max-height:80vh;
      overflow-y:auto; box-shadow:0 8px 24px rgba(0,0,0,.3);
      padding:16px; display:none; z-index:1002;
    }
    .modal-header {
      display:flex; justify-content:space-between;
      align-items:center; margin-bottom:12px;
    }
    .txn-card {
      border-top:1px solid #eee; padding:8px 0;
    }
    .txn-card:first-child { border:0 }
  </style>
</head>
<body>
  <div id="app">
    <!-- 1. Search bar at very top -->
    <div class="section">
      <input id="searchInput" placeholder="Search by date or user (Type + Enter)" />
    </div>

    <div style="margin-bottom:16px;">
      <button class="btn" style="background:orange; margin-right:12px;"
        onclick="location.href='https://gmolter.github.io/vend/more'">Dev Page</button>
      <button class="btn save"
        onclick="location.href='https://gmolter.github.io/vend/'">Stable Page</button>
    </div>

    <div class="section">
      <h1>Recent 6 Transactions</h1>
      <div id="recentContainer"><p>Loading recent…</p></div>
      <button id="moreBtn" class="btn save" style="display:none">More…</button>
    </div>

    <div class="section" id="browseWrapper">
      <h1>Browse</h1>
      <h2>By Date</h2>
      <div id="datesContainer" class="card-grid"><p>Loading dates…</p></div>
      <h2>By User</h2>
      <div id="usersContainer" class="card-grid"><p>Loading users…</p></div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop"></div>

  <!-- Search Modal -->
  <div id="searchModal" class="modal">
    <div class="modal-header">
      <h3 id="searchModalTitle">Search</h3>
      <button class="close-btn" onclick="closeModal()">X</button>
    </div>
    <div id="searchModalBody" class="modal-body"><p>Searching…</p></div>
  </div>

  <!-- Date Modal -->
  <div id="dateModal" class="modal">
    <div class="modal-header">
      <h3 id="dateModalTitle">Transactions</h3>
      <button class="close-btn" onclick="closeModal()">X</button>
    </div>
    <div id="dateModalBody" class="modal-body">Loading…</div>
  </div>

  <!-- User Modal -->
  <div id="userModal" class="modal">
    <div class="modal-header">
      <h3 id="userModalTitle">User</h3>
      <button class="close-btn" onclick="closeModal()">X</button>
    </div>
    <div id="userModalBody" class="modal-body">Loading…</div>
  </div>

  <script>
    (function(){
      const BASE = 'https://cyberflashvend-default-rtdb.firebaseio.com';
      const STUDENTS = {
        "260514":"Gavin Molter","250257":"Amit Ghumaan","251022":"Sun Bawi",
        "250202":"Mitchell Douglass","250298":"Heyden Halstead","270391":"Nate Jones",
        "280335":"Calli Justice","260913":"Levi Kane","280508":"Colden Oakley",
        "250606":"Madeline Penney","250639":"Rohan Rajanahalli","260627":"Mason Robbins",
        "360794":"Calix Baker","DEV":"DEV MODE"
      };

      let machineConfig = {}, logsData = {};

      // init Firebase & load data
      firebase.initializeApp({
        apiKey:"AIzaSyB3rahMcbUqRAetLoEKwwTDKf89I2sn85Y",
        authDomain:"cyberflashvend.firebaseapp.com",
        databaseURL:"https://cyberflashvend-default-rtdb.firebaseio.com/"
      });
      const db = firebase.database();

      db.ref('machineManagement').once('value')
        .then(snap => {
          machineConfig = snap.val() || {};
          return db.ref('Logs').orderByKey().limitToLast(30).once('value');
        })
        .then(snap => {
          logsData = snap.val() || {};
          renderRecent();
          renderBrowse();
          setupSearch();
        })
        .catch(err => console.error(err));

      function renderRecent(){
        const rc = document.getElementById('recentContainer');
        rc.innerHTML = '';
        const entries = [];
        Object.entries(logsData).forEach(([dk, logs]) => {
          const disp = dk.replace(/-/g,'/');
          Object.values(logs).forEach(l => {
            const items = (l.Payload+'').split(',').filter(x=>x).map(i=>{
              const cfg = machineConfig[i]||{};
              return cfg.name || `#${i}`;
            });
            entries.push({ disp, time:l.Time.replace(/s.*$/,''), user:l.User, items });
          });
        });
        entries.slice(-6).reverse().forEach(e => {
          const d = document.createElement('div');
          d.className = 'recent-card';
          d.innerHTML = `
            <p class="time">${e.disp} ${e.time}</p>
            <p>User: ${e.user}</p>
            <p>Items: ${e.items.join(', ')}</p>
          `;
          rc.appendChild(d);
        });
        if(entries.length>6){
          const mb = document.getElementById('moreBtn');
          mb.style.display = 'inline-block';
          mb.onclick = ()=>document.getElementById('browseWrapper')
                             .scrollIntoView({behavior:'smooth'});
        }
      }

      function renderBrowse(){
        const dc = document.getElementById('datesContainer'),
              uc = document.getElementById('usersContainer');
        dc.innerHTML = ''; uc.innerHTML = '';

        // dates
        Object.keys(logsData).sort((a,b)=>b.localeCompare(a)).forEach(dk=>{
          const c = document.createElement('div');
          c.className = 'date-card';
          c.innerHTML = `<span>${dk.replace(/-/g,'/')}</span>`;
          c.onclick = ()=>openDateModal(dk);
          dc.appendChild(c);
        });

        // users
        Object.entries(STUDENTS).sort((a,b)=>a[1].localeCompare(b[1])).forEach(([uid,name])=>{
          const c = document.createElement('div');
          c.className = 'user-card';
          c.innerHTML = `<span>${name}</span>`;
          c.onclick = ()=>openUserModal(uid);
          uc.appendChild(c);
        });
      }

      function setupSearch(){
        document.getElementById('searchInput')
          .addEventListener('keydown', e=>{
            if(e.key==='Enter'){
              e.preventDefault();
              openSearchModal(e.target.value.trim());
            }
          });
      }

      window.openSearchModal = q => {
        closeModal();
        const md = document.getElementById('searchModal'),
              bd = document.getElementById('searchModalBody'),
              tt = document.getElementById('searchModalTitle'),
              bp = document.getElementById('modalBackdrop');
        tt.textContent = `Search: "${q}"`;
        let html = '';
        const ql = q.toLowerCase();
        // dates
        Object.keys(logsData).forEach(dk=>{
          if(dk.replace(/-/g,'/').includes(ql)){
            html += `<button class="btn" onclick="openDateModal('${dk}')">
                        ${dk.replace(/-/g,'/')}
                     </button>`;
          }
        });
        // users
        Object.entries(STUDENTS).forEach(([uid,name])=>{
          if(name.toLowerCase().includes(ql)||uid.includes(ql)){
            html += `<button class="btn" onclick="openUserModal('${uid}')">${name}</button>`;
          }
        });
        bd.innerHTML = html || '<p>No matches.</p>';
        md.classList.add('active');
        bp.style.display = 'block';
      };

      window.openDateModal = dk => {
        closeModal();
        const md = document.getElementById('dateModal'),
              bd = document.getElementById('dateModalBody'),
              tt = document.getElementById('dateModalTitle'),
              bp = document.getElementById('modalBackdrop');
        tt.textContent = `Transactions on ${dk.replace(/-/g,'/')}`;
        let html = '';
        Object.values(logsData[dk]||{}).forEach(l=>{
          const items = (l.Payload+'').split(',').filter(x=>x).map(i=>{
            const cfg = machineConfig[i]||{};
            return cfg.name || `#${i}`;
          });
          html += `<div class="txn-card">
                     <p><strong>${l.Time.replace(/s.*$/,'')}</strong> — ${l.User}</p>
                     <p>Items: ${items.join(', ')}</p>
                   </div>`;
        });
        bd.innerHTML = html || '<p>No Transactions</p>';
        md.classList.add('active');
        bp.style.display = 'block';
      };

      window.openUserModal = uid => {
        closeModal();
        const md = document.getElementById('userModal'),
              bd = document.getElementById('userModalBody'),
              tt = document.getElementById('userModalTitle'),
              bp = document.getElementById('modalBackdrop');
        const name = STUDENTS[uid]||uid;
        tt.textContent = name;
        let html = `<p><strong>ID:</strong> ${uid}</p>`;
        const dates = Object.entries(logsData)
          .filter(([dk,logs])=>
            Object.values(logs).some(l=>l.User===name)
          )
          .map(([dk])=>dk)
          .sort((a,b)=>b.localeCompare(a));
        if(!dates.length) html += '<p>No Transactions</p>';
        else dates.forEach(dk=>{
          html += `<button class="btn" style="margin:4px;"
                       onclick="openDateModal('${dk}')">
                     ${dk.replace(/-/g,'/')}
                   </button>`;
        });
        bd.innerHTML = html;
        md.classList.add('active');
        bp.style.display = 'block';
      };

      window.closeModal = () => {
        document.getElementById('modalBackdrop').style.display = 'none';
        document.querySelectorAll('.modal')
                .forEach(m=>m.classList.remove('active'));
      };
    })();
  </script>
</body>
</html>
